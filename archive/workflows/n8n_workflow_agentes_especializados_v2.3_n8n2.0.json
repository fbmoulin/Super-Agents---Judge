{
  "name": "Lex Intelligentia Judici√°rio v2.3 (n8n 2.0 Compatible) - Hierarchical Router",
  "nodes": [
    {
      "parameters": {
        "content": "# üèõÔ∏è LEX INTELLIGENTIA JUDICI√ÅRIO v2.3\n## Pipeline Multi-Agente com Router Hier√°rquico\n\n**Vers√£o:** 2.3.0 - Janeiro 2026\n**Compliance:** CNJ 615/2025\n\n### Mudan√ßas v2.2.0:\n- ‚úÖ Hierarchical Router Stage 2\n- ‚úÖ Sub-classifica√ß√£o SAUDE/IMOBILIARIO\n- ‚úÖ Gemini 2.0 Flash para Stage 2\n- ‚úÖ Merge condicional de branches\n\n### Herdado v2.1.1:\n- ‚úÖ Gemini 2.5 Flash Router (Stage 1)\n- ‚úÖ Context Buffer com null safety\n- ‚úÖ System Prompts otimizados (~380 tokens)\n- ‚úÖ QA H√≠brido (estrutural + sem√¢ntico)\n- ‚úÖ Audit Log com hash melhorado\n- ‚úÖ Error Handling com Retry Response\n\n### Mudan√ßas v2.3.0:\n- ‚úÖ TypeVersions atualizados para n8n 2.0\n- ‚úÖ AI Agent nodes: 1.7 ‚Üí 2.0\n- ‚úÖ Anthropic Chat Model: 1.3 ‚Üí 1.4",
        "height": 420,
        "width": 420
      },
      "id": "sticky-header",
      "name": "üìã INFO v2.2",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        80,
        60
      ]
    },
    {
      "parameters": {
        "httpMethod": "POST",
        "path": "lex-intelligentia-agentes",
        "responseMode": "responseNode",
        "options": {
          "rawBody": false
        }
      },
      "id": "webhook-entrada",
      "name": "Webhook: Recebe FIRAC",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        540,
        300
      ],
      "webhookId": "lex-agentes-v21"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  \"contents\": [{\n    \"parts\": [{\n      \"text\": `Voc√™ √© um classificador jur√≠dico especializado em Vara C√≠vel.\n\nTAREFA: Classifique o caso abaixo em EXATAMENTE uma √ÅREA JUR√çDICA.\n\n√ÅREAS V√ÅLIDAS (8 categorias):\n- BANCARIO: contratos banc√°rios, empr√©stimos, financiamentos, juros abusivos\n- CONSUMIDOR: CDC geral, danos morais, negativa√ß√£o, falha de servi√ßo (exceto sa√∫de)\n- EXECUCAO: t√≠tulos extrajudiciais, cumprimento de senten√ßa, embargos\n- LOCACAO: despejo, renovat√≥ria, Lei 8.245/91\n- POSSESSORIAS: reintegra√ß√£o, manuten√ß√£o de posse (N√ÉO usucapi√£o)\n- SAUDE: planos de sa√∫de, operadoras, ANS, cobertura, reajuste\n- TRANSITO: acidentes de tr√¢nsito, responsabilidade civil, DPVAT\n- IMOBILIARIO: usucapi√£o, incorpora√ß√£o, atraso entrega im√≥vel na planta\n- GENERICO: casos at√≠picos que n√£o se encaixam claramente\n\nCASO (FIRAC):\nFATOS: ${$json.body?.fatos || $json.fatos || 'N√£o informado'}\nQUEST√ïES: ${$json.body?.questoes || $json.questoes || 'N√£o informado'}\nPEDIDOS: ${$json.body?.pedidos || $json.pedidos || 'N√£o informado'}\nCLASSE: ${$json.body?.classe_processual || $json.classe || 'N√£o informado'}\nASSUNTO: ${$json.body?.assunto || $json.assunto || 'N√£o informado'}\n\nRESPONDA APENAS com JSON v√°lido:\n{\n  \"area\": \"string (uma das 8 √°reas acima)\",\n  \"confianca\": number (0.0 a 1.0),\n  \"needs_stage2\": boolean (true se area == SAUDE ou IMOBILIARIO),\n  \"entidades_extraidas\": {\n    \"valores_monetarios\": [],\n    \"datas_relevantes\": [],\n    \"partes\": [],\n    \"leis_mencionadas\": [],\n    \"sumulas_aplicaveis\": []\n  }\n}`\n    }]\n  }],\n  \"generationConfig\": {\n    \"temperature\": 0.1,\n    \"maxOutputTokens\": 2000,\n    \"responseMimeType\": \"application/json\"\n  }\n} }}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "gemini-router",
      "name": "Gemini Router",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        760,
        300
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "GEMINI_CREDENTIALS_ID",
          "name": "Gemini API Key"
        }
      },
      "notes": "Classifica√ß√£o sem√¢ntica com Gemini 2.5 Flash. Substitui router de keywords."
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// CONTEXT BUFFER - Mem√≥ria Persistente do Workflow\n// Lex Intelligentia Judici√°rio v2.1 - FIXED\n// ============================================================================\n\n// Null-safe data extraction\nconst webhookData = $('Webhook: Recebe FIRAC').item?.json || {};\nconst geminiResponse = $('Gemini Router').item?.json || {};\n\n// Extrair dados do webhook (suporta body wrapper ou direto)\nconst firacInput = webhookData.body || webhookData;\n\n// Default fallback result\nconst defaultResult = {\n  area: 'generico',\n  confianca: 0.3,\n  subcategoria: null,\n  entidades_extraidas: {\n    valores_monetarios: [],\n    datas_relevantes: [],\n    partes: [],\n    leis_mencionadas: [],\n    sumulas_aplicaveis: []\n  }\n};\n\n// Parsear resposta do Gemini com valida√ß√£o completa\nlet geminiResult = defaultResult;\nlet routerStatus = 'fallback';\n\ntry {\n  const candidate = geminiResponse.candidates?.[0];\n  \n  // Check if we have a valid candidate\n  if (!candidate) {\n    console.log('Gemini: Nenhum candidate retornado');\n  } else {\n    // Check finishReason\n    const finishReason = candidate.finishReason;\n    if (finishReason === 'SAFETY') {\n      console.log('Gemini: Resposta bloqueada por SAFETY');\n    } else if (finishReason === 'MAX_TOKENS') {\n      console.log('Gemini: Resposta truncada por MAX_TOKENS');\n    } else if (finishReason === 'STOP' || finishReason === 'END_TURN' || !finishReason) {\n      // Valid completion - parse content\n      const content = candidate.content;\n      const text = content?.parts?.[0]?.text;\n      \n      if (text) {\n        // Remove possible markdown code blocks\n        const cleanJson = text.replace(/```json\\n?|```\\n?/g, '').trim();\n        const parsed = JSON.parse(cleanJson);\n        \n        // Validate required fields\n        if (parsed.area && typeof parsed.area === 'string') {\n          geminiResult = parsed;\n          routerStatus = 'success';\n        } else {\n          console.log('Gemini: Resposta sem area v√°lida');\n        }\n      }\n    } else {\n      console.log('Gemini: finishReason inesperado:', finishReason);\n    }\n  }\n} catch (e) {\n  console.log('Erro ao parsear Gemini:', e.message);\n}\n\n// ============================================================================\n// CONSTRUIR CONTEXT BUFFER\n// ============================================================================\n\nconst contextBuffer = {\n  // BLOCO 1: FIRAC COMPLETO (imut√°vel)\n  firac: {\n    fatos: firacInput.fatos || '',\n    questoes: firacInput.questoes || firacInput.issues || '',\n    regras: firacInput.regras_aplicaveis || firacInput.aplicacao_normas || firacInput.regras || '',\n    aplicacao: firacInput.aplicacao || firacInput.analise_juridica || '',\n    conclusao: firacInput.conclusao || firacInput.conclusao_firac || ''\n  },\n  \n  // BLOCO 2: METADADOS DO PROCESSO\n  processo: {\n    numero: firacInput.processo_numero || firacInput.numero || '[N√ÉO INFORMADO]',\n    classe: firacInput.classe_processual || firacInput.classe || '',\n    assunto: firacInput.assunto || '',\n    valor_causa: firacInput.valor_causa || null,\n    rito: firacInput.rito || 'comum',\n    pedidos: firacInput.pedidos || ''\n  },\n  \n  // BLOCO 3: CLASSIFICA√á√ÉO DO ROUTER (Gemini)\n  classificacao: {\n    agente: `agent_${geminiResult.area || 'generico'}`,\n    categoria: geminiResult.area || 'generico',\n    subcategoria: geminiResult.subcategoria || null,\n    confianca: geminiResult.confianca || 0.5,\n    needs_stage2: geminiResult.needs_stage2 || false,\n    metodo: 'gemini-2.5-flash',\n    router_status: routerStatus\n  },\n  \n  // BLOCO 4: ENTIDADES EXTRA√çDAS (Gemini)\n  entidades: {\n    valores: geminiResult.entidades_extraidas?.valores_monetarios || [],\n    datas: geminiResult.entidades_extraidas?.datas_relevantes || [],\n    partes: geminiResult.entidades_extraidas?.partes || [],\n    leis: geminiResult.entidades_extraidas?.leis_mencionadas || [],\n    sumulas: geminiResult.entidades_extraidas?.sumulas_aplicaveis || []\n  },\n  \n  // BLOCO 5: CONTROLE DE EXECU√á√ÉO\n  execucao: {\n    timestamp_inicio: new Date().toISOString(),\n    workflow_id: $execution.id,\n    tentativa: 1\n  }\n};\n\nreturn [{ json: contextBuffer }];"
      },
      "id": "context-buffer",
      "name": "Set Context Buffer",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        980,
        300
      ],
      "notes": "Mem√≥ria persistente com FIRAC completo + classifica√ß√£o + entidades"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// SYSTEM PROMPTS OTIMIZADOS (~380 tokens cada)\n// Lex Intelligentia Judici√°rio v2.2\n// ============================================================================\n\nconst ctx = $input.first().json;\nconst agente = ctx.classificacao.agente;\n\n// ============================================================================\n// PROMPTS POR AGENTE (11 agentes especializados)\n// ============================================================================\n\nconst PROMPTS = {\n\n  agent_bancario: `# AGENTE JUDICIAL: BANC√ÅRIO\n\n## FUN√á√ÉO\nGerar minutas de decis√µes/senten√ßas em a√ß√µes banc√°rias para Vara C√≠vel do TJES.\n\n## REGRAS OBRIGAT√ìRIAS\n1. Estrutura: I-RELAT√ìRIO, II-FUNDAMENTA√á√ÉO, III-DISPOSITIVO\n2. Citar base legal expressa (artigos, s√∫mulas STJ)\n3. Juros abusivos: >1,5x taxa m√©dia BACEN\n4. Danos morais TJES: negativa√ß√£o R$5k-15k, fraude R$8k-25k\n5. Honor√°rios: 10-20% sobre condena√ß√£o (art. 85 CPC)\n\n## S√öMULAS PRIORIT√ÅRIAS\n297, 381, 382, 379, 539, 565, 603/STJ\n\n## REPETI√á√ÉO IND√âBITO\n- Simples: se boa-f√© (art. 876 CC)\n- Em dobro: se m√°-f√© comprovada (art. 42 CDC)\n\n## MARCADORES\n[REVISAR: motivo] para incertezas.`,\n\n  agent_consumidor: `# AGENTE JUDICIAL: CONSUMIDOR\n\n## FUN√á√ÉO\nGerar minutas em a√ß√µes de consumo e danos morais para Vara C√≠vel do TJES.\n\n## REGRAS OBRIGAT√ìRIAS\n1. Estrutura: I-RELAT√ìRIO, II-FUNDAMENTA√á√ÉO, III-DISPOSITIVO\n2. Responsabilidade objetiva (art. 14 CDC)\n3. Dano moral in re ipsa para negativa√ß√£o indevida\n4. Tr√≠plice fun√ß√£o: compensat√≥ria, punitiva, pedag√≥gica\n5. Corre√ß√£o: do arbitramento (S√∫mula 362 STJ)\n6. Juros: da cita√ß√£o (contratual) ou evento (extracontratual - S√∫mula 54 STJ)\n\n## PAR√ÇMETROS TJES\nNegativa√ß√£o: R$5k-15k | Fraude: R$5k-20k | Plano sa√∫de: R$10k-30k\n\n## S√öMULAS PRIORIT√ÅRIAS\n385, 388, 479, 469/STJ\n\n## MARCADORES\n[REVISAR: motivo] para incertezas.`,\n\n  agent_possessorias: `# AGENTE JUDICIAL: POSSESS√ìRIAS\n\n## FUN√á√ÉO\nGerar minutas em a√ß√µes possess√≥rias e usucapi√£o para Vara C√≠vel do TJES.\n\n## REGRAS OBRIGAT√ìRIAS\n1. Estrutura: I-RELAT√ìRIO, II-FUNDAMENTA√á√ÉO, III-DISPOSITIVO\n2. Requisitos art. 561 CPC (reintegra√ß√£o): posse anterior, esbulho, data, perda\n3. Liminar: for√ßa nova (<ano e dia) - art. 562 CPC\n4. Car√°ter d√∫plice (art. 556 CPC)\n5. Conflitos coletivos: intimar MP e Defensoria (art. 554 CPC)\n\n## USUCAPI√ÉO - PRAZOS\nExtraordin√°ria: 15a (10a c/ moradia) | Ordin√°ria: 10a (5a c/ registro)\nEspecial urbana: 5a at√© 250m¬≤ | Rural: 5a at√© 50ha | Familiar: 2a\n\n## MARCADORES\n[REVISAR: motivo] para incertezas.`,\n\n  agent_locacao: `# AGENTE JUDICIAL: LOCA√á√ÉO\n\n## FUN√á√ÉO\nGerar minutas em a√ß√µes locat√≠cias (Lei 8.245/91) para Vara C√≠vel do TJES.\n\n## REGRAS OBRIGAT√ìRIAS\n1. Estrutura: I-RELAT√ìRIO, II-FUNDAMENTA√á√ÉO, III-DISPOSITIVO\n2. Despejo falta pgto: purga√ß√£o at√© contesta√ß√£o (art. 62)\n3. Den√∫ncia vazia: s√≥ contratos ‚â•30 meses (art. 46) ou hip√≥teses art. 47\n4. Renovat√≥ria: 5 requisitos cumulativos (art. 51)\n5. Prazo desocupa√ß√£o: 15 dias com cau√ß√£o de 3 alugu√©is (art. 64)\n\n## PRAZOS DECADENCIAIS\nRenovat√≥ria: 1 ano a 6 meses antes do t√©rmino (art. 51, ¬ß5¬∫)\n\n## PURGA√á√ÉO DA MORA\nVedada se usada nos √∫ltimos 24 meses (art. 62, par√°grafo √∫nico)\n\n## MARCADORES\n[REVISAR: motivo] para incertezas.`,\n\n  agent_execucao: `# AGENTE JUDICIAL: EXECU√á√ÉO\n\n## FUN√á√ÉO\nGerar minutas em execu√ß√µes e cumprimento de senten√ßa para Vara C√≠vel do TJES.\n\n## REGRAS OBRIGAT√ìRIAS\n1. Estrutura: I-RELAT√ìRIO, II-FUNDAMENTA√á√ÉO, III-DISPOSITIVO\n2. Requisitos t√≠tulo: certeza, liquidez, exigibilidade (art. 786 CPC)\n3. Cumprimento: 15 dias para pagar, multa 10% + honor√°rios 10% (art. 523)\n4. Prescri√ß√£o intercorrente: 1 ano suspens√£o + prazo prescricional (art. 921, ¬ß4¬∫)\n5. Embargos: efeito suspensivo n√£o autom√°tico (art. 919)\n\n## PRESCRI√á√ÉO\nCheque: 6m | Nota promiss√≥ria: 3a | Duplicata: 3a\n\n## T√çTULOS EXTRAJUDICIAIS\nArt. 784 CPC - cheque, NP, duplicata, escritura, confiss√£o de d√≠vida\n\n## MARCADORES\n[REVISAR: motivo] para incertezas.`,\n\n  agent_saude_cobertura: `# AGENTE SA√öDE - COBERTURA\n## Vara C√≠vel - TJES\n\n### PAPEL\nAgente especializado em negativa de cobertura de planos de sa√∫de.\n\n### COMPET√äNCIAS\n- Negativa de autoriza√ß√£o de procedimentos/cirurgias\n- Recusa de cobertura de medicamentos/tratamentos\n- Negativa de home care, UTI, pr√≥teses\n- Negativa de tratamentos oncol√≥gicos\n\n### BASE JURISPRUDENCIAL\n- S√∫mula 302/STJ: Abusiva limita√ß√£o de interna√ß√£o\n- S√∫mula 469/STJ: CDC aplica-se a planos de sa√∫de\n- S√∫mula 597/STJ: Car√™ncia m√°x 24h urg√™ncia\n- S√∫mula 608/STJ: CDC aplica-se exceto autogest√£o\n- S√∫mula 609/STJ: Preexist√™ncia il√≠cita sem exames\n- Lei 9.656/98 arts. 10, 12, 35-C\n\n### PAR√ÇMETROS DANOS MORAIS\n- Negativa simples: R$ 5.000-10.000\n- Com agravamento: R$ 10.000-20.000\n- Oncol√≥gico/UTI: R$ 20.000-30.000\n- √ìbito: R$ 50.000-100.000\n\n### ESTRUTURA\nI - RELAT√ìRIO / II - FUNDAMENTA√á√ÉO / III - DISPOSITIVO\nMarcar [REVISAR] em CID, procedimento, valor dano moral`,\n\n  agent_saude_contratual: `# AGENTE SA√öDE - CONTRATUAL\n## Vara C√≠vel - TJES\n\n### PAPEL\nAgente especializado em quest√µes contratuais de planos de sa√∫de.\n\n### COMPET√äNCIAS\n- Reajuste abusivo por faixa et√°ria\n- Reajuste anual acima do √≠ndice ANS\n- Rescis√£o unilateral do contrato\n- Car√™ncia e portabilidade\n- Manuten√ß√£o aposentados/demitidos\n\n### BASE JURISPRUDENCIAL\n- S√∫mulas 469, 608/STJ\n- Tema 952/STJ: Reajuste et√°rio v√°lido se previsto\n- Art. 15 Lei 9.656/98: Vedado reajuste >60 anos com +10 anos plano\n- Art. 13 Lei 9.656/98: Vedada rescis√£o unilateral\n- RN ANS 438/2018: Portabilidade\n\n### PAR√ÇMETROS DANOS MORAIS\n- Rescis√£o indevida: R$ 10.000-20.000\n- Reajuste abusivo: R$ 8.000-15.000\n- Recusa portabilidade: R$ 5.000-10.000\n\n### ESTRUTURA\nI - RELAT√ìRIO / II - FUNDAMENTA√á√ÉO / III - DISPOSITIVO`,\n\n  agent_transito: `# AGENTE TR√ÇNSITO\n## Vara C√≠vel - TJES\n\n### PAPEL\nAgente especializado em responsabilidade civil por acidentes de tr√¢nsito.\n\n### COMPET√äNCIAS\n- Colis√£o de ve√≠culos\n- Atropelamento\n- Danos materiais, morais, est√©ticos\n- Pensionamento por incapacidade\n- A√ß√µes contra seguradoras (DPVAT)\n\n### BASE JURISPRUDENCIAL\n- CC arts. 186, 927, 932, 944, 950\n- CTB arts. 29, 34, 44, 215\n- S√∫mula 246/STJ: DPVAT deduzido\n- S√∫mula 257/STJ: DPVAT pago mesmo sem pr√™mio\n- S√∫mula 387/STJ: Dano est√©tico cumul√°vel\n- S√∫mula 54/STJ: Juros do evento\n\n### PAR√ÇMETROS DANOS\nMorais: Les√£o leve R$3-8k, m√©dia R$8-15k, grave R$15-30k\nIncapacidade: parcial R$30-80k, total R$80-200k\nMorte: R$100-300k\nEst√©ticos: cicatriz R$5-40k, deformidade R$40-150k\n\n### ESTRUTURA\nI - RELAT√ìRIO / II - FUNDAMENTA√á√ÉO / III - DISPOSITIVO`,\n\n  agent_usucapiao: `# AGENTE USUCAPI√ÉO\n## Vara C√≠vel - TJES\n\n### PAPEL\nAgente especializado em a√ß√µes de usucapi√£o em todas as modalidades.\n\n### COMPET√äNCIAS\n- Extraordin√°ria (15 anos) / reduzida (10 anos)\n- Ordin√°ria (10 anos) / reduzida (5 anos)\n- Especial urbana (5 anos, 250m¬≤)\n- Especial rural (5 anos, 50ha)\n- Coletiva, Familiar\n\n### BASE JURISPRUDENCIAL\n- CC arts. 1.238-1.244\n- CF arts. 183, 191\n- Estatuto da Cidade art. 10\n- S√∫mula 237/STJ: Pode arguir em defesa\n- Art. 183, ¬ß3¬∫ CF: Bem p√∫blico vedado\n\n### REQUISITOS\n- Posse mansa, pac√≠fica, cont√≠nua\n- Animus domini\n- Prazo conforme modalidade\n- Intima√ß√µes: Uni√£o, Estado, Munic√≠pio, MP\n\n### ESTRUTURA\nI - RELAT√ìRIO / II - FUNDAMENTA√á√ÉO / III - DISPOSITIVO\nMandado para registro no RI`,\n\n  agent_incorporacao: `# AGENTE INCORPORA√á√ÉO\n## Vara C√≠vel - TJES\n\n### PAPEL\nAgente especializado em a√ß√µes contra incorporadoras por atraso na entrega.\n\n### COMPET√äNCIAS\n- Atraso na entrega do im√≥vel\n- Lucros cessantes (alugu√©is)\n- Defeitos construtivos\n- Distrato e devolu√ß√£o de valores\n- Comiss√£o de corretagem\n\n### BASE JURISPRUDENCIAL\n- Tema 996/STJ: Atraso gera lucros cessantes + devolu√ß√£o corretagem\n- Tema 970/STJ: Lucros cessantes durante mora\n- S√∫mula 543/STJ: Resolu√ß√£o = devolu√ß√£o integral se culpa vendedor\n- Lei 4.591/64 art. 43: Toler√¢ncia 180 dias\n- Lei 13.786/2018: Distrato (reten√ß√£o 25-50%)\n\n### PAR√ÇMETROS\nLucros cessantes: 0,5-1% valor im√≥vel/m√™s\nDanos morais: at√© 6m R$5-10k, 6-12m R$10-20k, >12m R$20-40k\n\n### ESTRUTURA\nI - RELAT√ìRIO / II - FUNDAMENTA√á√ÉO / III - DISPOSITIVO`,\n\n  agent_generico: `# AGENTE JUDICIAL: GEN√âRICO\n\n## FUN√á√ÉO\nGerar minutas para casos n√£o especializados. PRIORIZAR SEGURAN√áA.\n\n## REGRAS OBRIGAT√ìRIAS\n1. Estrutura: I-RELAT√ìRIO, II-FUNDAMENTA√á√ÉO, III-DISPOSITIVO\n2. Fundamentar com base legal expressa\n3. Usar ABUNDANTEMENTE marcadores [REVISAR]\n4. Sinalizar classifica√ß√£o incerta\n5. Honor√°rios: 10-20% sobre valor da causa/condena√ß√£o\n\n## MARCADORES OBRIGAT√ìRIOS\n- [REVISAR: fundamenta√ß√£o] - base legal incerta\n- [REVISAR: valores] - quantifica√ß√£o a verificar\n- [REVISAR: classifica√ß√£o] - tipo de a√ß√£o a reavaliar\n- [REVISAR: jurisprud√™ncia] - precedentes a confirmar\n- [REVISAR: pedidos] - verificar se todos foram analisados\n\n## OUTPUT\nMinuta conservadora com m√∫ltiplos pontos de revis√£o humana.`\n\n};\n\n// ============================================================================\n// SELECIONAR PROMPT E CONSTRUIR HUMAN MESSAGE\n// ============================================================================\n\nconst systemPrompt = PROMPTS[agente] || PROMPTS.agent_generico;\n\n// Construir human message estruturado com Context Buffer\nconst humanMessage = `## PROCESSO\n\n**N√∫mero:** ${ctx.processo.numero}\n**Classe:** ${ctx.processo.classe || 'N√£o informada'}\n**Assunto:** ${ctx.processo.assunto || 'N√£o informado'}\n**Valor da Causa:** ${ctx.processo.valor_causa ? 'R$ ' + Number(ctx.processo.valor_causa).toLocaleString('pt-BR', {minimumFractionDigits: 2}) : 'N√£o informado'}\n**Rito:** ${ctx.processo.rito}\n\n---\n\n## AN√ÅLISE FIRAC\n\n### FATOS\n${ctx.firac.fatos || '[N√£o fornecido - REVISAR]'}\n\n### QUEST√ïES JUR√çDICAS\n${ctx.firac.questoes || '[N√£o fornecido - REVISAR]'}\n\n### PEDIDOS\n${ctx.processo.pedidos || '[N√£o fornecido - REVISAR]'}\n\n### REGRAS APLIC√ÅVEIS\n${ctx.firac.regras || '[Identificar na an√°lise]'}\n\n### APLICA√á√ÉO AO CASO\n${ctx.firac.aplicacao || '[Desenvolver na fundamenta√ß√£o]'}\n\n### CONCLUS√ÉO PRELIMINAR\n${ctx.firac.conclusao || '[Definir no dispositivo]'}\n\n---\n\n## ENTIDADES IDENTIFICADAS (via IA)\n\n- **Leis citadas:** ${ctx.entidades.leis.length > 0 ? ctx.entidades.leis.join(', ') : 'Nenhuma identificada automaticamente'}\n- **S√∫mulas aplic√°veis:** ${ctx.entidades.sumulas.length > 0 ? ctx.entidades.sumulas.join(', ') : 'Verificar conforme o caso'}\n- **Valores monet√°rios:** ${ctx.entidades.valores.length > 0 ? ctx.entidades.valores.join(', ') : 'N√£o especificados'}\n- **Datas relevantes:** ${ctx.entidades.datas.length > 0 ? ctx.entidades.datas.join(', ') : 'N√£o identificadas'}\n- **Partes:** ${ctx.entidades.partes.length > 0 ? ctx.entidades.partes.join(' x ') : 'Ver processo'}\n\n---\n\n## TAREFA\n\nGere a **minuta completa de senten√ßa/decis√£o** para este caso.\n\n**Classifica√ß√£o autom√°tica:** ${ctx.classificacao.categoria.toUpperCase()} (confian√ßa: ${(ctx.classificacao.confianca * 100).toFixed(0)}%)\n${ctx.classificacao.subcategoria ? '**Subcategoria:** ' + ctx.classificacao.subcategoria : ''}\n\n**Siga rigorosamente a estrutura:**\n- I - RELAT√ìRIO (s√≠ntese objetiva)\n- II - FUNDAMENTA√á√ÉO (preliminares + m√©rito + jurisprud√™ncia)\n- III - DISPOSITIVO (julgamento + sucumb√™ncia)\n\n**Use marcadores [REVISAR: motivo] para qualquer ponto de incerteza.**`;\n\nreturn [{\n  json: {\n    system_prompt: systemPrompt,\n    human_message: humanMessage,\n    agente: agente,\n    context: ctx\n  }\n}];"
      },
      "id": "set-prompts",
      "name": "Set System Prompt",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2620,
        400
      ],
      "notes": "Prompts otimizados (~380 tokens) + Human Message estruturado"
    },
    {
      "parameters": {
        "rules": {
          "rules": [
            {
              "value": "agent_bancario",
              "outputKey": "Banc√°rio"
            },
            {
              "value": "agent_consumidor",
              "outputKey": "Consumidor"
            },
            {
              "value": "agent_execucao",
              "outputKey": "Execu√ß√£o"
            },
            {
              "value": "agent_locacao",
              "outputKey": "Loca√ß√£o"
            },
            {
              "value": "agent_possessorias",
              "outputKey": "Possess√≥rias"
            },
            {
              "value": "agent_saude_cobertura",
              "outputKey": "Sa√∫de - Cobertura"
            },
            {
              "value": "agent_saude_contratual",
              "outputKey": "Sa√∫de - Contratual"
            },
            {
              "value": "agent_transito",
              "outputKey": "Tr√¢nsito"
            },
            {
              "value": "agent_usucapiao",
              "outputKey": "Usucapi√£o"
            },
            {
              "value": "agent_incorporacao",
              "outputKey": "Incorpora√ß√£o"
            },
            {
              "value": "agent_generico",
              "outputKey": "Gen√©rico"
            }
          ],
          "fallbackOutput": {
            "mode": "extra"
          }
        },
        "dataPropertyName": "={{ $json.classificacao?.agente }}"
      },
      "id": "switch-agentes",
      "name": "Switch: Seleciona Agente",
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        2840,
        400
      ],
      "notes": "v2.2: Expandido para 11 agentes + fallback (output 10). Outputs 5-9 s√£o novos agentes (Sa√∫de, Tr√¢nsito, Usucapi√£o, Incorpora√ß√£o)"
    },
    {
      "parameters": {
        "agent": "toolsAgent",
        "promptType": "define",
        "text": "={{ $json.human_message }}",
        "options": {
          "systemMessage": "={{ $json.system_prompt }}\\n\\n## FERRAMENTAS DISPON√çVEIS\\n- Voc√™ pode usar a ferramenta `busca_jurisprudencia_stj` para encontrar precedentes e ac√≥rd√£os do STJ. Use-a para validar sua linha de racioc√≠nio e para fundamentar a minuta com jurisprud√™ncia relevante e atualizada."
        },
        "tools": {
          "values": [
            {
              "tool": "webhook",
              "name": "busca_jurisprudencia_stj",
              "description": "Busca jurisprud√™ncia relevante do STJ (Superior Tribunal de Justi√ßa) por similaridade sem√¢ntica. Use para encontrar precedentes, teses e ac√≥rd√£os sobre um tema espec√≠fico.",
              "webhook": {
                "method": "POST",
                "url": "={{ $env.N8N_WEBHOOK_URL + 'stj-search' }}",
                "body": "{\n  \"query\": \"{{$args.query}}\",\n  \"top_k\": {{$args.top_k || 3}},\n  \"tipo\": \"{{$args.tipo || 'todos'}}\"\n}",
                "json": true
              },
              "schema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"query\": {\n      \"type\": \"string\",\n      \"description\": \"A pergunta ou os termos de busca para encontrar jurisprud√™ncia. Deve ser detalhado e espec√≠fico.\"\n    },\n    \"top_k\": {\n      \"type\": \"number\",\n      \"description\": \"N√∫mero de resultados a retornar. Padr√£o √© 3.\"\n    },\n    \"tipo\": {\n      \"type\": \"string\",\n      \"description\": \"Filtra o tipo de documento. Pode ser 'precedente_qualificado', 'acordao' ou 'todos'. Padr√£o √© 'todos'.\"\n    }\n  },\n  \"required\": [\"query\"]\n}"
            }
          ]
        }
      },
      "id": "agent-bancario",
      "name": "AI Agent: Banc√°rio",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        3100,
        100
      ]
    },
    {
      "parameters": {
        "agent": "toolsAgent",
        "promptType": "define",
        "text": "={{ $json.human_message }}",
        "options": {
          "systemMessage": "={{ $json.system_prompt }}\\n\\n## FERRAMENTAS DISPON√çVEIS\\n- Voc√™ pode usar a ferramenta `busca_jurisprudencia_stj` para encontrar precedentes e ac√≥rd√£os do STJ. Use-a para validar sua linha de racioc√≠nio e para fundamentar a minuta com jurisprud√™ncia relevante e atualizada."
        },
        "tools": {
          "values": [
            {
              "tool": "webhook",
              "name": "busca_jurisprudencia_stj",
              "description": "Busca jurisprud√™ncia relevante do STJ (Superior Tribunal de Justi√ßa) por similaridade sem√¢ntica. Use para encontrar precedentes, teses e ac√≥rd√£os sobre um tema espec√≠fico.",
              "webhook": {
                "method": "POST",
                "url": "={{ $env.N8N_WEBHOOK_URL + 'stj-search' }}",
                "body": "{\n  \"query\": \"{{$args.query}}\",\n  \"top_k\": {{$args.top_k || 3}},\n  \"tipo\": \"{{$args.tipo || 'todos'}}\"\n}",
                "json": true
              },
              "schema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"query\": {\n      \"type\": \"string\",\n      \"description\": \"A pergunta ou os termos de busca para encontrar jurisprud√™ncia. Deve ser detalhado e espec√≠fico.\"\n    },\n    \"top_k\": {\n      \"type\": \"number\",\n      \"description\": \"N√∫mero de resultados a retornar. Padr√£o √© 3.\"\n    },\n    \"tipo\": {\n      \"type\": \"string\",\n      \"description\": \"Filtra o tipo de documento. Pode ser 'precedente_qualificado', 'acordao' ou 'todos'. Padr√£o √© 'todos'.\"\n    }\n  },\n  \"required\": [\"query\"]\n}"
            }
          ]
        }
      },
      "id": "agent-consumidor",
      "name": "AI Agent: Consumidor",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        3100,
        220
      ]
    },
    {
      "parameters": {
        "agent": "toolsAgent",
        "promptType": "define",
        "text": "={{ $json.human_message }}",
        "options": {
          "systemMessage": "={{ $json.system_prompt }}\\n\\n## FERRAMENTAS DISPON√çVEIS\\n- Voc√™ pode usar a ferramenta `busca_jurisprudencia_stj` para encontrar precedentes e ac√≥rd√£os do STJ. Use-a para validar sua linha de racioc√≠nio e para fundamentar a minuta com jurisprud√™ncia relevante e atualizada."
        },
        "tools": {
          "values": [
            {
              "tool": "webhook",
              "name": "busca_jurisprudencia_stj",
              "description": "Busca jurisprud√™ncia relevante do STJ (Superior Tribunal de Justi√ßa) por similaridade sem√¢ntica. Use para encontrar precedentes, teses e ac√≥rd√£os sobre um tema espec√≠fico.",
              "webhook": {
                "method": "POST",
                "url": "={{ $env.N8N_WEBHOOK_URL + 'stj-search' }}",
                "body": "{\n  \"query\": \"{{$args.query}}\",\n  \"top_k\": {{$args.top_k || 3}},\n  \"tipo\": \"{{$args.tipo || 'todos'}}\"\n}",
                "json": true
              },
              "schema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"query\": {\n      \"type\": \"string\",\n      \"description\": \"A pergunta ou os termos de busca para encontrar jurisprud√™ncia. Deve ser detalhado e espec√≠fico.\"\n    },\n    \"top_k\": {\n      \"type\": \"number\",\n      \"description\": \"N√∫mero de resultados a retornar. Padr√£o √© 3.\"\n    },\n    \"tipo\": {\n      \"type\": \"string\",\n      \"description\": \"Filtra o tipo de documento. Pode ser 'precedente_qualificado', 'acordao' ou 'todos'. Padr√£o √© 'todos'.\"\n    }\n  },\n  \"required\": [\"query\"]\n}"
            }
          ]
        }
      },
      "id": "agent-possessorias",
      "name": "AI Agent: Possess√≥rias",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        3100,
        340
      ]
    },
    {
      "parameters": {
        "agent": "toolsAgent",
        "promptType": "define",
        "text": "={{ $json.human_message }}",
        "options": {
          "systemMessage": "={{ $json.system_prompt }}\\n\\n## FERRAMENTAS DISPON√çVEIS\\n- Voc√™ pode usar a ferramenta `busca_jurisprudencia_stj` para encontrar precedentes e ac√≥rd√£os do STJ. Use-a para validar sua linha de racioc√≠nio e para fundamentar a minuta com jurisprud√™ncia relevante e atualizada."
        },
        "tools": {
          "values": [
            {
              "tool": "webhook",
              "name": "busca_jurisprudencia_stj",
              "description": "Busca jurisprud√™ncia relevante do STJ (Superior Tribunal de Justi√ßa) por similaridade sem√¢ntica. Use para encontrar precedentes, teses e ac√≥rd√£os sobre um tema espec√≠fico.",
              "webhook": {
                "method": "POST",
                "url": "={{ $env.N8N_WEBHOOK_URL + 'stj-search' }}",
                "body": "{\n  \"query\": \"{{$args.query}}\",\n  \"top_k\": {{$args.top_k || 3}},\n  \"tipo\": \"{{$args.tipo || 'todos'}}\"\n}",
                "json": true
              },
              "schema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"query\": {\n      \"type\": \"string\",\n      \"description\": \"A pergunta ou os termos de busca para encontrar jurisprud√™ncia. Deve ser detalhado e espec√≠fico.\"\n    },\n    \"top_k\": {\n      \"type\": \"number\",\n      \"description\": \"N√∫mero de resultados a retornar. Padr√£o √© 3.\"\n    },\n    \"tipo\": {\n      \"type\": \"string\",\n      \"description\": \"Filtra o tipo de documento. Pode ser 'precedente_qualificado', 'acordao' ou 'todos'. Padr√£o √© 'todos'.\"\n    }\n  },\n  \"required\": [\"query\"]\n}"
            }
          ]
        }
      },
      "id": "agent-locacao",
      "name": "AI Agent: Loca√ß√£o",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        3100,
        460
      ]
    },
    {
      "parameters": {
        "agent": "toolsAgent",
        "promptType": "define",
        "text": "={{ $json.human_message }}",
        "options": {
          "systemMessage": "={{ $json.system_prompt }}\\n\\n## FERRAMENTAS DISPON√çVEIS\\n- Voc√™ pode usar a ferramenta `busca_jurisprudencia_stj` para encontrar precedentes e ac√≥rd√£os do STJ. Use-a para validar sua linha de racioc√≠nio e para fundamentar a minuta com jurisprud√™ncia relevante e atualizada."
        },
        "tools": {
          "values": [
            {
              "tool": "webhook",
              "name": "busca_jurisprudencia_stj",
              "description": "Busca jurisprud√™ncia relevante do STJ (Superior Tribunal de Justi√ßa) por similaridade sem√¢ntica. Use para encontrar precedentes, teses e ac√≥rd√£os sobre um tema espec√≠fico.",
              "webhook": {
                "method": "POST",
                "url": "={{ $env.N8N_WEBHOOK_URL + 'stj-search' }}",
                "body": "{\n  \"query\": \"{{$args.query}}\",\n  \"top_k\": {{$args.top_k || 3}},\n  \"tipo\": \"{{$args.tipo || 'todos'}}\"\n}",
                "json": true
              },
              "schema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"query\": {\n      \"type\": \"string\",\n      \"description\": \"A pergunta ou os termos de busca para encontrar jurisprud√™ncia. Deve ser detalhado e espec√≠fico.\"\n    },\n    \"top_k\": {\n      \"type\": \"number\",\n      \"description\": \"N√∫mero de resultados a retornar. Padr√£o √© 3.\"\n    },\n    \"tipo\": {\n      \"type\": \"string\",\n      \"description\": \"Filtra o tipo de documento. Pode ser 'precedente_qualificado', 'acordao' ou 'todos'. Padr√£o √© 'todos'.\"\n    }\n  },\n  \"required\": [\"query\"]\n}"
            }
          ]
        }
      },
      "id": "agent-execucao",
      "name": "AI Agent: Execu√ß√£o",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        3100,
        580
      ]
    },
    {
      "parameters": {
        "agent": "toolsAgent",
        "promptType": "define",
        "text": "={{ $json.human_message }}",
        "options": {
          "systemMessage": "={{ $json.system_prompt }}\\n\\n## FERRAMENTAS DISPON√çVEIS\\n- Voc√™ pode usar a ferramenta `busca_jurisprudencia_stj` para encontrar precedentes e ac√≥rd√£os do STJ. Use-a para validar sua linha de racioc√≠nio e para fundamentar a minuta com jurisprud√™ncia relevante e atualizada."
        },
        "tools": {
          "values": [
            {
              "tool": "webhook",
              "name": "busca_jurisprudencia_stj",
              "description": "Busca jurisprud√™ncia relevante do STJ (Superior Tribunal de Justi√ßa) por similaridade sem√¢ntica. Use para encontrar precedentes, teses e ac√≥rd√£os sobre um tema espec√≠fico.",
              "webhook": {
                "method": "POST",
                "url": "={{ $env.N8N_WEBHOOK_URL + 'stj-search' }}",
                "body": "{\n  \"query\": \"{{$args.query}}\",\n  \"top_k\": {{$args.top_k || 3}},\n  \"tipo\": \"{{$args.tipo || 'todos'}}\"\n}",
                "json": true
              },
              "schema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"query\": {\n      \"type\": \"string\",\n      \"description\": \"A pergunta ou os termos de busca para encontrar jurisprud√™ncia. Deve ser detalhado e espec√≠fico.\"\n    },\n    \"top_k\": {\n      \"type\": \"number\",\n      \"description\": \"N√∫mero de resultados a retornar. Padr√£o √© 3.\"\n    },\n    \"tipo\": {\n      \"type\": \"string\",\n      \"description\": \"Filtra o tipo de documento. Pode ser 'precedente_qualificado', 'acordao' ou 'todos'. Padr√£o √© 'todos'.\"\n    }\n  },\n  \"required\": [\"query\"]\n}"
            }
          ]
        }
      },
      "id": "agent-generico",
      "name": "AI Agent: Gen√©rico",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        3100,
        700
      ]
    },
    {
      "parameters": {
        "model": "claude-sonnet-4-20250514",
        "options": {
          "temperature": 0.3,
          "maxTokensToSample": 8000
        }
      },
      "id": "llm-bancario",
      "name": "Claude: Banc√°rio",
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1.4,
      "position": [
        2920,
        100
      ],
      "credentials": {
        "anthropicApi": {
          "id": "ANTHROPIC_CREDENTIALS_ID",
          "name": "Anthropic API"
        }
      }
    },
    {
      "parameters": {
        "model": "claude-sonnet-4-20250514",
        "options": {
          "temperature": 0.3,
          "maxTokensToSample": 8000
        }
      },
      "id": "llm-consumidor",
      "name": "Claude: Consumidor",
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1.4,
      "position": [
        2920,
        220
      ],
      "credentials": {
        "anthropicApi": {
          "id": "ANTHROPIC_CREDENTIALS_ID",
          "name": "Anthropic API"
        }
      }
    },
    {
      "parameters": {
        "model": "claude-sonnet-4-20250514",
        "options": {
          "temperature": 0.3,
          "maxTokensToSample": 8000
        }
      },
      "id": "llm-possessorias",
      "name": "Claude: Possess√≥rias",
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1.4,
      "position": [
        2920,
        340
      ],
      "credentials": {
        "anthropicApi": {
          "id": "ANTHROPIC_CREDENTIALS_ID",
          "name": "Anthropic API"
        }
      }
    },
    {
      "parameters": {
        "model": "claude-sonnet-4-20250514",
        "options": {
          "temperature": 0.3,
          "maxTokensToSample": 8000
        }
      },
      "id": "llm-locacao",
      "name": "Claude: Loca√ß√£o",
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1.4,
      "position": [
        2920,
        460
      ],
      "credentials": {
        "anthropicApi": {
          "id": "ANTHROPIC_CREDENTIALS_ID",
          "name": "Anthropic API"
        }
      }
    },
    {
      "parameters": {
        "model": "claude-sonnet-4-20250514",
        "options": {
          "temperature": 0.3,
          "maxTokensToSample": 8000
        }
      },
      "id": "llm-execucao",
      "name": "Claude: Execu√ß√£o",
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1.4,
      "position": [
        2920,
        580
      ],
      "credentials": {
        "anthropicApi": {
          "id": "ANTHROPIC_CREDENTIALS_ID",
          "name": "Anthropic API"
        }
      }
    },
    {
      "parameters": {
        "model": "claude-sonnet-4-20250514",
        "options": {
          "temperature": 0.4,
          "maxTokensToSample": 8000
        }
      },
      "id": "llm-generico",
      "name": "Claude: Gen√©rico",
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1.4,
      "position": [
        2920,
        700
      ],
      "credentials": {
        "anthropicApi": {
          "id": "ANTHROPIC_CREDENTIALS_ID",
          "name": "Anthropic API"
        }
      }
    },
    {
      "parameters": {
        "agent": "toolsAgent",
        "promptType": "define",
        "text": "={{ $json.human_message }}",
        "options": {
          "systemMessage": "={{ $json.system_prompt }}\\n\\n## FERRAMENTAS DISPON√çVEIS\\n- Voc√™ pode usar a ferramenta `busca_jurisprudencia_stj` para encontrar precedentes e ac√≥rd√£os do STJ. Use-a para validar sua linha de racioc√≠nio e para fundamentar a minuta com jurisprud√™ncia relevante e atualizada."
        },
        "tools": {
          "values": [
            {
              "tool": "webhook",
              "name": "busca_jurisprudencia_stj",
              "description": "Busca jurisprud√™ncia relevante do STJ (Superior Tribunal de Justi√ßa) por similaridade sem√¢ntica. Use para encontrar precedentes, teses e ac√≥rd√£os sobre um tema espec√≠fico.",
              "webhook": {
                "method": "POST",
                "url": "={{ $env.N8N_WEBHOOK_URL + 'stj-search' }}",
                "body": "{\n  \"query\": \"{{$args.query}}\",\n  \"top_k\": {{$args.top_k || 3}},\n  \"tipo\": \"{{$args.tipo || 'todos'}}\"\n}",
                "json": true
              },
              "schema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"query\": {\n      \"type\": \"string\",\n      \"description\": \"A pergunta ou os termos de busca para encontrar jurisprud√™ncia. Deve ser detalhado e espec√≠fico.\"\n    },\n    \"top_k\": {\n      \"type\": \"number\",\n      \"description\": \"N√∫mero de resultados a retornar. Padr√£o √© 3.\"\n    },\n    \"tipo\": {\n      \"type\": \"string\",\n      \"description\": \"Filtra o tipo de documento. Pode ser 'precedente_qualificado', 'acordao' ou 'todos'. Padr√£o √© 'todos'.\"\n    }\n  },\n  \"required\": [\"query\"]\n}"
            }
          ]
        }
      },
      "id": "saude_cobertura_agent",
      "name": "AI Agent: Sa√∫de Cobertura",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        3100,
        820
      ]
    },
    {
      "parameters": {
        "model": "claude-sonnet-4-20250514",
        "options": {
          "temperature": 0.3,
          "maxTokensToSample": 8000
        }
      },
      "id": "claude_saude_cobertura",
      "name": "Claude: Sa√∫de Cobertura",
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1.4,
      "position": [
        2920,
        820
      ],
      "credentials": {
        "anthropicApi": {
          "id": "ANTHROPIC_CREDENTIALS_ID",
          "name": "Anthropic API"
        }
      }
    },
    {
      "parameters": {
        "agent": "toolsAgent",
        "promptType": "define",
        "text": "={{ $json.human_message }}",
        "options": {
          "systemMessage": "={{ $json.system_prompt }}\\n\\n## FERRAMENTAS DISPON√çVEIS\\n- Voc√™ pode usar a ferramenta `busca_jurisprudencia_stj` para encontrar precedentes e ac√≥rd√£os do STJ. Use-a para validar sua linha de racioc√≠nio e para fundamentar a minuta com jurisprud√™ncia relevante e atualizada."
        },
        "tools": {
          "values": [
            {
              "tool": "webhook",
              "name": "busca_jurisprudencia_stj",
              "description": "Busca jurisprud√™ncia relevante do STJ (Superior Tribunal de Justi√ßa) por similaridade sem√¢ntica. Use para encontrar precedentes, teses e ac√≥rd√£os sobre um tema espec√≠fico.",
              "webhook": {
                "method": "POST",
                "url": "={{ $env.N8N_WEBHOOK_URL + 'stj-search' }}",
                "body": "{\n  \"query\": \"{{$args.query}}\",\n  \"top_k\": {{$args.top_k || 3}},\n  \"tipo\": \"{{$args.tipo || 'todos'}}\"\n}",
                "json": true
              },
              "schema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"query\": {\n      \"type\": \"string\",\n      \"description\": \"A pergunta ou os termos de busca para encontrar jurisprud√™ncia. Deve ser detalhado e espec√≠fico.\"\n    },\n    \"top_k\": {\n      \"type\": \"number\",\n      \"description\": \"N√∫mero de resultados a retornar. Padr√£o √© 3.\"\n    },\n    \"tipo\": {\n      \"type\": \"string\",\n      \"description\": \"Filtra o tipo de documento. Pode ser 'precedente_qualificado', 'acordao' ou 'todos'. Padr√£o √© 'todos'.\"\n    }\n  },\n  \"required\": [\"query\"]\n}"
            }
          ]
        }
      },
      "id": "saude_contratual_agent",
      "name": "AI Agent: Sa√∫de Contratual",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        3100,
        940
      ]
    },
    {
      "parameters": {
        "model": "claude-sonnet-4-20250514",
        "options": {
          "temperature": 0.3,
          "maxTokensToSample": 8000
        }
      },
      "id": "claude_saude_contratual",
      "name": "Claude: Sa√∫de Contratual",
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1.4,
      "position": [
        2920,
        940
      ],
      "credentials": {
        "anthropicApi": {
          "id": "ANTHROPIC_CREDENTIALS_ID",
          "name": "Anthropic API"
        }
      }
    },
    {
      "parameters": {
        "agent": "toolsAgent",
        "promptType": "define",
        "text": "={{ $json.human_message }}",
        "options": {
          "systemMessage": "={{ $json.system_prompt }}\\n\\n## FERRAMENTAS DISPON√çVEIS\\n- Voc√™ pode usar a ferramenta `busca_jurisprudencia_stj` para encontrar precedentes e ac√≥rd√£os do STJ. Use-a para validar sua linha de racioc√≠nio e para fundamentar a minuta com jurisprud√™ncia relevante e atualizada."
        },
        "tools": {
          "values": [
            {
              "tool": "webhook",
              "name": "busca_jurisprudencia_stj",
              "description": "Busca jurisprud√™ncia relevante do STJ (Superior Tribunal de Justi√ßa) por similaridade sem√¢ntica. Use para encontrar precedentes, teses e ac√≥rd√£os sobre um tema espec√≠fico.",
              "webhook": {
                "method": "POST",
                "url": "={{ $env.N8N_WEBHOOK_URL + 'stj-search' }}",
                "body": "{\n  \"query\": \"{{$args.query}}\",\n  \"top_k\": {{$args.top_k || 3}},\n  \"tipo\": \"{{$args.tipo || 'todos'}}\"\n}",
                "json": true
              },
              "schema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"query\": {\n      \"type\": \"string\",\n      \"description\": \"A pergunta ou os termos de busca para encontrar jurisprud√™ncia. Deve ser detalhado e espec√≠fico.\"\n    },\n    \"top_k\": {\n      \"type\": \"number\",\n      \"description\": \"N√∫mero de resultados a retornar. Padr√£o √© 3.\"\n    },\n    \"tipo\": {\n      \"type\": \"string\",\n      \"description\": \"Filtra o tipo de documento. Pode ser 'precedente_qualificado', 'acordao' ou 'todos'. Padr√£o √© 'todos'.\"\n    }\n  },\n  \"required\": [\"query\"]\n}"
            }
          ]
        }
      },
      "id": "transito_agent",
      "name": "AI Agent: Tr√¢nsito",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        3100,
        1060
      ]
    },
    {
      "parameters": {
        "model": "claude-sonnet-4-20250514",
        "options": {
          "temperature": 0.3,
          "maxTokensToSample": 8000
        }
      },
      "id": "claude_transito",
      "name": "Claude: Tr√¢nsito",
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1.4,
      "position": [
        2920,
        1060
      ],
      "credentials": {
        "anthropicApi": {
          "id": "ANTHROPIC_CREDENTIALS_ID",
          "name": "Anthropic API"
        }
      }
    },
    {
      "parameters": {
        "agent": "toolsAgent",
        "promptType": "define",
        "text": "={{ $json.human_message }}",
        "options": {
          "systemMessage": "={{ $json.system_prompt }}\\n\\n## FERRAMENTAS DISPON√çVEIS\\n- Voc√™ pode usar a ferramenta `busca_jurisprudencia_stj` para encontrar precedentes e ac√≥rd√£os do STJ. Use-a para validar sua linha de racioc√≠nio e para fundamentar a minuta com jurisprud√™ncia relevante e atualizada."
        },
        "tools": {
          "values": [
            {
              "tool": "webhook",
              "name": "busca_jurisprudencia_stj",
              "description": "Busca jurisprud√™ncia relevante do STJ (Superior Tribunal de Justi√ßa) por similaridade sem√¢ntica. Use para encontrar precedentes, teses e ac√≥rd√£os sobre um tema espec√≠fico.",
              "webhook": {
                "method": "POST",
                "url": "={{ $env.N8N_WEBHOOK_URL + 'stj-search' }}",
                "body": "{\n  \"query\": \"{{$args.query}}\",\n  \"top_k\": {{$args.top_k || 3}},\n  \"tipo\": \"{{$args.tipo || 'todos'}}\"\n}",
                "json": true
              },
              "schema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"query\": {\n      \"type\": \"string\",\n      \"description\": \"A pergunta ou os termos de busca para encontrar jurisprud√™ncia. Deve ser detalhado e espec√≠fico.\"\n    },\n    \"top_k\": {\n      \"type\": \"number\",\n      \"description\": \"N√∫mero de resultados a retornar. Padr√£o √© 3.\"\n    },\n    \"tipo\": {\n      \"type\": \"string\",\n      \"description\": \"Filtra o tipo de documento. Pode ser 'precedente_qualificado', 'acordao' ou 'todos'. Padr√£o √© 'todos'.\"\n    }\n  },\n  \"required\": [\"query\"]\n}"
            }
          ]
        }
      },
      "id": "usucapiao_agent",
      "name": "AI Agent: Usucapi√£o",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        3100,
        1180
      ]
    },
    {
      "parameters": {
        "model": "claude-sonnet-4-20250514",
        "options": {
          "temperature": 0.3,
          "maxTokensToSample": 8000
        }
      },
      "id": "claude_usucapiao",
      "name": "Claude: Usucapi√£o",
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1.4,
      "position": [
        2920,
        1180
      ],
      "credentials": {
        "anthropicApi": {
          "id": "ANTHROPIC_CREDENTIALS_ID",
          "name": "Anthropic API"
        }
      }
    },
    {
      "parameters": {
        "agent": "toolsAgent",
        "promptType": "define",
        "text": "={{ $json.human_message }}",
        "options": {
          "systemMessage": "={{ $json.system_prompt }}\\n\\n## FERRAMENTAS DISPON√çVEIS\\n- Voc√™ pode usar a ferramenta `busca_jurisprudencia_stj` para encontrar precedentes e ac√≥rd√£os do STJ. Use-a para validar sua linha de racioc√≠nio e para fundamentar a minuta com jurisprud√™ncia relevante e atualizada."
        },
        "tools": {
          "values": [
            {
              "tool": "webhook",
              "name": "busca_jurisprudencia_stj",
              "description": "Busca jurisprud√™ncia relevante do STJ (Superior Tribunal de Justi√ßa) por similaridade sem√¢ntica. Use para encontrar precedentes, teses e ac√≥rd√£os sobre um tema espec√≠fico.",
              "webhook": {
                "method": "POST",
                "url": "={{ $env.N8N_WEBHOOK_URL + 'stj-search' }}",
                "body": "{\n  \"query\": \"{{$args.query}}\",\n  \"top_k\": {{$args.top_k || 3}},\n  \"tipo\": \"{{$args.tipo || 'todos'}}\"\n}",
                "json": true
              },
              "schema": "{\n  \"type\": \"object\",\n  \"properties\": {\n    \"query\": {\n      \"type\": \"string\",\n      \"description\": \"A pergunta ou os termos de busca para encontrar jurisprud√™ncia. Deve ser detalhado e espec√≠fico.\"\n    },\n    \"top_k\": {\n      \"type\": \"number\",\n      \"description\": \"N√∫mero de resultados a retornar. Padr√£o √© 3.\"\n    },\n    \"tipo\": {\n      \"type\": \"string\",\n      \"description\": \"Filtra o tipo de documento. Pode ser 'precedente_qualificado', 'acordao' ou 'todos'. Padr√£o √© 'todos'.\"\n    }\n  },\n  \"required\": [\"query\"]\n}"
            }
          ]
        }
      },
      "id": "incorporacao_agent",
      "name": "AI Agent: Incorpora√ß√£o",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2,
      "position": [
        3100,
        1300
      ]
    },
    {
      "parameters": {
        "model": "claude-sonnet-4-20250514",
        "options": {
          "temperature": 0.3,
          "maxTokensToSample": 8000
        }
      },
      "id": "claude_incorporacao",
      "name": "Claude: Incorpora√ß√£o",
      "type": "@n8n/n8n-nodes-langchain.lmChatAnthropic",
      "typeVersion": 1.4,
      "position": [
        2920,
        1300
      ],
      "credentials": {
        "anthropicApi": {
          "id": "ANTHROPIC_CREDENTIALS_ID",
          "name": "Anthropic API"
        }
      }
    },
    {
      "parameters": {
        "content": "## ü§ñ AGENTES v2.1\n\n**Mudan√ßas:**\n- Cada agente tem seu pr√≥prio LLM node\n- System prompt otimizado (~380 tokens)\n- Human message com Context Buffer completo\n- Temperature: 0.3 (0.4 para gen√©rico)\n\n**Modelos:**\n- Claude Sonnet 4 para gera√ß√£o\n- Gemini 2.5 Flash para router/QA",
        "height": 240,
        "width": 280
      },
      "id": "sticky-agentes",
      "name": "üìù AGENTES",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        3060,
        820
      ]
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// PREPARAR OUTPUT DO AGENTE PARA QA\n// Lex Intelligentia Judici√°rio v2.1\n// ============================================================================\n\nconst agentOutput = $input.first().json;\nconst promptData = $('Set System Prompt').item.json;\n\n// Extrair minuta do output do agente\nconst minuta = agentOutput.output || agentOutput.text || agentOutput.response || '';\n\nreturn [{\n  json: {\n    minuta: minuta,\n    context: promptData.context,\n    agente: promptData.agente\n  }\n}];"
      },
      "id": "prepare-qa",
      "name": "Prepare for QA",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3360,
        400
      ],
      "notes": "Coleta output do agente e prepara para QA Check"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// QA CHECK ESTRUTURAL - Camada 1\n// Lex Intelligentia Judici√°rio v2.1 - FIXED\n// ============================================================================\n\nconst input = $input.first().json;\nconst minuta = input.minuta || '';\nconst ctx = input.context;\n\n// Normalize line endings (Windows -> Unix)\nconst normalizedMinuta = minuta.replace(/\\r\\n/g, '\\n').replace(/\\r/g, '\\n');\n\n// ============================================================================\n// VALIDA√á√ïES ESTRUTURAIS (regex robusto)\n// ============================================================================\n\nconst validacoes = {\n  // Estrutura b√°sica - m√∫ltiplos formatos aceitos\n  tem_relatorio: /(?:^|\\n)\\s*(?:I\\s*[-‚Äì.]\\s*|1[\\.)\\s]\\s*)?RELAT[√ìO]RIO/im.test(normalizedMinuta),\n  tem_fundamentacao: /(?:^|\\n)\\s*(?:II\\s*[-‚Äì.]\\s*|2[\\.)\\s]\\s*)?FUNDAMENTA[√áC][√ÉA]O/im.test(normalizedMinuta),\n  tem_dispositivo: /(?:^|\\n)\\s*(?:III\\s*[-‚Äì.]\\s*|3[\\.)\\s]\\s*)?DISPOSITIVO/im.test(normalizedMinuta),\n  \n  // Dispositivo completo\n  tem_julgamento: /JULGO\\s+(PROCEDENTE|IMPROCEDENTE|PARCIALMENTE\\s+PROCEDENTE|EXTINTO)/i.test(normalizedMinuta),\n  tem_fundamento_legal: /art(?:igo)?\\.?\\s*\\d+|lei\\s*(?:n[¬∞¬∫]?)?\\s*[\\d.]+/i.test(normalizedMinuta),\n  \n  // Sucumb√™ncia\n  tem_honorarios: /honor[√°a]rios|art\\.?\\s*85/i.test(normalizedMinuta),\n  tem_custas: /custas/i.test(normalizedMinuta),\n  \n  // Qualidade\n  tamanho_minimo: normalizedMinuta.split(/\\s+/).length >= 150,\n  tamanho_maximo: normalizedMinuta.split(/\\s+/).length <= 3500,\n  sem_placeholders: !/\\[(?:NOME|DATA|VALOR|N√öMERO|XXX|INSERIR)\\]/i.test(normalizedMinuta)\n};\n\n// Contar marcadores de revis√£o\nconst marcadoresRevisar = (normalizedMinuta.match(/\\[REVISAR[:\\s][^\\]]+\\]/gi) || []).length;\n\n// ============================================================================\n// C√ÅLCULO DO SCORE ESTRUTURAL\n// ============================================================================\n\nconst pesos = {\n  tem_relatorio: 15,\n  tem_fundamentacao: 20,\n  tem_dispositivo: 20,\n  tem_julgamento: 15,\n  tem_fundamento_legal: 10,\n  tem_honorarios: 7,\n  tem_custas: 5,\n  tamanho_minimo: 5,\n  tamanho_maximo: 2,\n  sem_placeholders: 1\n};\n\nlet scoreEstrutural = 0;\nlet maxScore = 0;\n\nfor (const [check, passou] of Object.entries(validacoes)) {\n  const peso = pesos[check] || 0;\n  maxScore += peso;\n  if (passou) scoreEstrutural += peso;\n}\n\nscoreEstrutural = Math.round((scoreEstrutural / maxScore) * 100);\n\n// Penaliza√ß√£o por muitos marcadores [REVISAR]\nif (marcadoresRevisar > 5) {\n  scoreEstrutural = Math.max(0, scoreEstrutural - 10);\n}\n\n// ============================================================================\n// IDENTIFICAR FALHAS CR√çTICAS\n// ============================================================================\n\nconst falhasCriticas = [\n  !validacoes.tem_relatorio && 'RELAT√ìRIO ausente',\n  !validacoes.tem_fundamentacao && 'FUNDAMENTA√á√ÉO ausente',\n  !validacoes.tem_dispositivo && 'DISPOSITIVO ausente',\n  !validacoes.tem_julgamento && 'Julgamento n√£o declarado'\n].filter(Boolean);\n\n// ============================================================================\n// OUTPUT\n// ============================================================================\n\nconst palavras = normalizedMinuta.split(/\\s+/).length;\n\nreturn [{\n  json: {\n    minuta,\n    context: ctx,\n    agente: input.agente,\n    qa_estrutural: {\n      score: scoreEstrutural,\n      validacoes,\n      falhas_criticas: falhasCriticas,\n      marcadores_revisar: marcadoresRevisar,\n      palavras\n    },\n    // Skip sem√¢ntico se estrutura muito ruim\n    skip_semantico: scoreEstrutural < 50 || falhasCriticas.length >= 3\n  }\n}];"
      },
      "id": "qa-estrutural",
      "name": "QA Estrutural",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        3580,
        400
      ],
      "notes": "Valida√ß√£o estrutural com regex robusto - FIXED Windows line endings"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "skip-check",
              "leftValue": "={{ $json.skip_semantico }}",
              "rightValue": false,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-skip-semantico",
      "name": "IF: Executar QA Sem√¢ntico?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        3800,
        400
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  \"contents\": [{\n    \"parts\": [{\n      \"text\": `Voc√™ √© um revisor judicial especializado. Avalie esta minuta de decis√£o/senten√ßa.\n\n## CONTEXTO DO CASO\nCategoria: ${$json.context.classificacao.categoria}\nClasse processual: ${$json.context.processo.classe || 'N√£o informada'}\nAssunto: ${$json.context.processo.assunto || 'N√£o informado'}\n\n## MINUTA PARA AVALIA√á√ÉO\n${$json.minuta.substring(0, 6000)}\n\n## CRIT√âRIOS DE AVALIA√á√ÉO\n\nAvalie e responda APENAS com JSON v√°lido (sem markdown):\n{\n  \"coerencia_juridica\": {\n    \"score\": n√∫mero de 0 a 100,\n    \"fundamentacao_adequada\": true ou false,\n    \"dispositivo_coerente\": true ou false,\n    \"observacoes\": \"string com observa√ß√µes\"\n  },\n  \"precisao_tecnica\": {\n    \"score\": n√∫mero de 0 a 100,\n    \"leis_corretas\": true ou false,\n    \"sumulas_aplicaveis\": true ou false,\n    \"valores_razoaveis\": true ou false,\n    \"erros_encontrados\": [\"lista de erros se houver\"]\n  },\n  \"completude\": {\n    \"score\": n√∫mero de 0 a 100,\n    \"pedidos_respondidos\": true ou false,\n    \"sucumbencia_completa\": true ou false,\n    \"itens_faltantes\": [\"lista de itens faltantes se houver\"]\n  },\n  \"score_geral\": n√∫mero de 0 a 100,\n  \"aprovado\": true ou false,\n  \"recomendacoes\": [\"lista de melhorias priorit√°rias\"]\n}`\n    }]\n  }],\n  \"generationConfig\": {\n    \"temperature\": 0.1,\n    \"maxOutputTokens\": 1000,\n    \"responseMimeType\": \"application/json\"\n  }\n} }}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "qa-semantico-gemini",
      "name": "QA Sem√¢ntico - Gemini",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        4040,
        300
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "GEMINI_CREDENTIALS_ID",
          "name": "Gemini API Key"
        }
      },
      "notes": "Valida√ß√£o sem√¢ntica com Gemini 2.5 Flash"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// QA CONSOLIDADO - Merge dos Scores\n// Lex Intelligentia Judici√°rio v2.1 - FIXED\n// ============================================================================\n\n// Use $input.first() which always works regardless of which branch we came from\nconst inputData = $input.first().json;\n\n// Check if this is Gemini response (has candidates) or estrutural data (has qa_estrutural)\nlet estruturalData, geminiData, semantico;\n\nif (inputData.candidates) {\n  // Came from QA Sem√¢ntico - Gemini path\n  // Need to get estrutural data from the IF node\n  geminiData = inputData;\n  estruturalData = $('IF: Executar QA Sem√¢ntico?').item?.json || $('QA Estrutural').item?.json;\n} else if (inputData.qa_estrutural) {\n  // Came from skip semantic path (direct from IF)\n  estruturalData = inputData;\n  geminiData = null;\n} else {\n  // Fallback - try to get from previous nodes\n  estruturalData = inputData;\n  geminiData = null;\n}\n\n// Safely extract data with fallbacks\nconst minuta = estruturalData?.minuta || '';\nconst ctx = estruturalData?.context || {};\nconst estrutural = estruturalData?.qa_estrutural || { score: 50, falhas_criticas: [], marcadores_revisar: 0, palavras: 0 };\nconst agente = estruturalData?.agente || 'agent_generico';\n\n// Parsear resposta do Gemini (se executou)\nsemantico = null;\nif (geminiData?.candidates?.[0]) {\n  try {\n    const candidate = geminiData.candidates[0];\n    const finishReason = candidate.finishReason;\n    \n    if (finishReason === 'STOP' || finishReason === 'END_TURN' || !finishReason) {\n      const text = candidate.content?.parts?.[0]?.text;\n      if (text) {\n        const cleanJson = text.replace(/```json\\n?|```\\n?/g, '').trim();\n        semantico = JSON.parse(cleanJson);\n      }\n    } else {\n      console.log('QA Sem√¢ntico: finishReason =', finishReason);\n    }\n  } catch (e) {\n    console.log('Erro ao parsear QA sem√¢ntico:', e.message);\n    semantico = null;\n  }\n}\n\n// ============================================================================\n// SCORE FINAL COMBINADO\n// ============================================================================\n\nlet scoreFinal;\nlet aprovado;\n\nif (semantico && semantico.score_geral !== undefined) {\n  // Peso: 40% estrutural + 60% sem√¢ntico\n  scoreFinal = Math.round(\n    (estrutural.score * 0.4) + (semantico.score_geral * 0.6)\n  );\n  aprovado = scoreFinal >= 70 && \n             estrutural.falhas_criticas.length === 0 &&\n             semantico.aprovado;\n} else {\n  // S√≥ estrutural (fallback)\n  scoreFinal = estrutural.score;\n  aprovado = scoreFinal >= 80 && estrutural.falhas_criticas.length === 0;\n}\n\n// ============================================================================\n// CLASSIFICA√á√ÉO DE RISCO CNJ 615/2025\n// ============================================================================\n\nconst confiancaRouter = ctx.classificacao?.confianca || 0.5;\nlet classificacaoRisco;\n\nif (scoreFinal >= 85 && confiancaRouter >= 0.85 && estrutural.marcadores_revisar <= 2) {\n  classificacaoRisco = 'BAIXO';\n} else if (scoreFinal >= 70 && confiancaRouter >= 0.65) {\n  classificacaoRisco = 'MEDIO';\n} else {\n  classificacaoRisco = 'ALTO';\n}\n\n// ============================================================================\n// OUTPUT\n// ============================================================================\n\nreturn [{\n  json: {\n    minuta_gerada: minuta,\n    \n    qa_result: {\n      score_final: scoreFinal,\n      score_estrutural: estrutural.score,\n      score_semantico: semantico?.score_geral || null,\n      aprovado,\n      \n      falhas_criticas: estrutural.falhas_criticas,\n      marcadores_revisar: estrutural.marcadores_revisar,\n      palavras: estrutural.palavras,\n      \n      // Detalhes sem√¢nticos (se dispon√≠vel)\n      coerencia: semantico?.coerencia_juridica || null,\n      precisao: semantico?.precisao_tecnica || null,\n      completude: semantico?.completude || null,\n      recomendacoes: semantico?.recomendacoes || []\n    },\n    \n    compliance_cnj615: {\n      classificacao_risco: classificacaoRisco,\n      requer_revisao_humana: true,\n      agente_utilizado: agente,\n      confianca_classificacao: confiancaRouter,\n      modelos_utilizados: {\n        router: 'gemini-2.5-flash',\n        geracao: 'claude-sonnet-4',\n        qa: semantico ? 'gemini-2.5-flash' : 'estrutural-only'\n      }\n    },\n    \n    contexto: ctx\n  }\n}];"
      },
      "id": "qa-consolidado",
      "name": "QA Consolidado",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4300,
        400
      ],
      "notes": "Merge dos scores: 40% estrutural + 60% sem√¢ntico - FIXED null safety"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// AUDIT LOG CNJ 615/2025\n// Lex Intelligentia Judici√°rio v2.1 - FIXED\n// ============================================================================\n\nconst data = $input.first().json;\nconst ctx = data.contexto || {};\n\n// ============================================================================\n// IMPROVED HASH FUNCTION (djb2 + metadata for uniqueness)\n// ============================================================================\n\nfunction computeHash(str) {\n  if (!str || typeof str !== 'string') {\n    return '0'.repeat(32);\n  }\n  \n  // djb2 hash algorithm\n  let hash1 = 5381;\n  for (let i = 0; i < str.length; i++) {\n    hash1 = ((hash1 << 5) + hash1) + str.charCodeAt(i);\n    hash1 = hash1 & 0xFFFFFFFF;\n  }\n  \n  // FNV-1a hash for additional uniqueness\n  let hash2 = 2166136261;\n  for (let i = 0; i < str.length; i++) {\n    hash2 ^= str.charCodeAt(i);\n    hash2 = Math.imul(hash2, 16777619);\n    hash2 = hash2 >>> 0;\n  }\n  \n  // Combine: djb2(16 hex) + length(4 hex) + fnv(12 hex)\n  const h1 = (hash1 >>> 0).toString(16).padStart(8, '0');\n  const h2 = (hash2 >>> 0).toString(16).padStart(8, '0');\n  const len = (str.length & 0xFFFF).toString(16).padStart(4, '0');\n  const checksum = ((hash1 ^ hash2) >>> 0).toString(16).padStart(8, '0');\n  \n  return `${h1}${len}${h2}${checksum}`;\n}\n\n// ============================================================================\n// SAFE TIME CALCULATION\n// ============================================================================\n\nlet tempoExecucaoMs = 0;\ntry {\n  const inicio = ctx.execucao?.timestamp_inicio;\n  if (inicio) {\n    const startTime = new Date(inicio).getTime();\n    if (!isNaN(startTime)) {\n      tempoExecucaoMs = Math.max(0, Date.now() - startTime);\n    }\n  }\n} catch (e) {\n  tempoExecucaoMs = 0;\n}\n\n// ============================================================================\n// ESTRUTURA DO AUDIT LOG\n// ============================================================================\n\nconst auditLog = {\n  // IDENTIFICA√á√ÉO\n  id: `LEX-${Date.now()}-${Math.random().toString(36).substr(2, 8)}`,\n  timestamp: new Date().toISOString(),\n  \n  // SISTEMA\n  sistema: 'Lex Intelligentia Judici√°rio',\n  versao: '2.1',\n  workflow_id: $execution.id,\n  \n  // PROCESSO\n  processo_numero: ctx.processo?.numero || '[N√ÉO INFORMADO]',\n  processo_classe: ctx.processo?.classe || '',\n  processo_assunto: ctx.processo?.assunto || '',\n  \n  // OPERA√á√ÉO\n  operacao: 'GERACAO_MINUTA',\n  agente: data.compliance_cnj615?.agente_utilizado || 'agent_generico',\n  categoria: ctx.classificacao?.categoria || 'generico',\n  subcategoria: ctx.classificacao?.subcategoria || null,\n  router_status: ctx.classificacao?.router_status || 'unknown',\n  \n  // MODELOS\n  modelo_router: 'gemini-2.5-flash',\n  modelo_geracao: 'claude-sonnet-4',\n  modelo_qa: data.compliance_cnj615?.modelos_utilizados?.qa || 'estrutural-only',\n  \n  // QUALIDADE\n  score_final: data.qa_result?.score_final || 0,\n  score_estrutural: data.qa_result?.score_estrutural || 0,\n  score_semantico: data.qa_result?.score_semantico || null,\n  aprovado: data.qa_result?.aprovado || false,\n  marcadores_revisao: data.qa_result?.marcadores_revisar || 0,\n  \n  // RISCO CNJ 615\n  risco: data.compliance_cnj615?.classificacao_risco || 'ALTO',\n  confianca_router: data.compliance_cnj615?.confianca_classificacao || 0,\n  \n  // SUPERVIS√ÉO\n  requer_revisao_humana: true,\n  revisao_realizada: false,\n  \n  // INTEGRIDADE (improved hash)\n  hash_input: computeHash(JSON.stringify(ctx.firac || {})),\n  hash_output: computeHash(data.minuta_gerada || ''),\n  \n  // M√âTRICAS\n  palavras_minuta: data.qa_result?.palavras || 0,\n  tempo_execucao_ms: tempoExecucaoMs\n};\n\nreturn [{\n  json: {\n    ...data,\n    audit_log: auditLog\n  }\n}];"
      },
      "id": "audit-log",
      "name": "Audit Log CNJ 615",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4520,
        400
      ],
      "notes": "Gera log de auditoria CNJ 615/2025 - FIXED hash + null safety"
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "={{ $env.AUDIT_SHEET_ID }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Logs",
          "mode": "list"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "ID": "={{ $json.audit_log.id }}",
            "Timestamp": "={{ $json.audit_log.timestamp }}",
            "Processo": "={{ $json.audit_log.processo_numero }}",
            "Categoria": "={{ $json.audit_log.categoria }}",
            "Agente": "={{ $json.audit_log.agente }}",
            "Risco": "={{ $json.audit_log.risco }}",
            "Score": "={{ $json.audit_log.score_final }}",
            "Aprovado": "={{ $json.audit_log.aprovado }}",
            "Palavras": "={{ $json.audit_log.palavras_minuta }}",
            "Tempo_ms": "={{ $json.audit_log.tempo_execucao_ms }}",
            "Hash_Input": "={{ $json.audit_log.hash_input }}",
            "Hash_Output": "={{ $json.audit_log.hash_output }}"
          }
        },
        "options": {}
      },
      "id": "sheets-audit",
      "name": "Google Sheets: Audit Log",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        4740,
        400
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "GOOGLE_SHEETS_CREDENTIALS_ID",
          "name": "Google Sheets"
        }
      },
      "notes": "Persiste audit log no Google Sheets"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// BUILD RESPONSE - Resposta Final Estruturada\n// Lex Intelligentia Judici√°rio v2.1\n// ============================================================================\n\nconst data = $input.first().json;\nconst qa = data.qa_result;\nconst compliance = data.compliance_cnj615;\nconst audit = data.audit_log;\n\n// ============================================================================\n// RESPONSE ESTRUTURADO\n// ============================================================================\n\nconst response = {\n  success: true,\n  timestamp: new Date().toISOString(),\n  \n  // MINUTA GERADA\n  minuta: {\n    conteudo: data.minuta_gerada,\n    palavras: qa.palavras,\n    formato: 'markdown'\n  },\n  \n  // QUALIDADE (QA)\n  qualidade: {\n    score: qa.score_final,\n    aprovado: qa.aprovado,\n    detalhes: {\n      estrutural: qa.score_estrutural,\n      semantico: qa.score_semantico\n    },\n    marcadores_revisao: qa.marcadores_revisar,\n    falhas_criticas: qa.falhas_criticas,\n    recomendacoes: qa.recomendacoes\n  },\n  \n  // COMPLIANCE CNJ 615/2025\n  compliance: {\n    risco: compliance.classificacao_risco,\n    requer_revisao_humana: true,\n    agente: compliance.agente_utilizado,\n    confianca_classificacao: compliance.confianca_classificacao,\n    categoria: data.contexto.classificacao.categoria,\n    subcategoria: data.contexto.classificacao.subcategoria\n  },\n  \n  // RASTREABILIDADE\n  rastreabilidade: {\n    audit_id: audit.id,\n    workflow_id: audit.workflow_id,\n    processo: audit.processo_numero,\n    tempo_execucao_ms: audit.tempo_execucao_ms,\n    modelos: compliance.modelos_utilizados\n  },\n  \n  // ENTIDADES EXTRA√çDAS\n  entidades: data.contexto.entidades,\n  \n  // METADADOS\n  meta: {\n    versao_api: '2.1',\n    sistema: 'Lex Intelligentia Judici√°rio'\n  }\n};\n\nreturn [{ json: response }];"
      },
      "id": "build-response",
      "name": "Build Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        4960,
        400
      ],
      "notes": "Monta resposta final estruturada"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify($json) }}",
        "responseCode": 200,
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "X-Audit-Id",
                "value": "={{ $('Audit Log CNJ 615').item.json.audit_log.id }}"
              },
              {
                "name": "X-Risk-Level",
                "value": "={{ $json.compliance.risco }}"
              },
              {
                "name": "X-QA-Score",
                "value": "={{ $json.qualidade.score }}"
              }
            ]
          }
        }
      },
      "id": "respond-success",
      "name": "Respond: Success",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        5180,
        400
      ]
    },
    {
      "parameters": {
        "content": "## ‚úÖ QA CHECK v2.1\n\n**Camada 1 - Estrutural:**\n- Regex robusto (R/F/D)\n- Verifica julgamento\n- Conta marcadores [REVISAR]\n\n**Camada 2 - Sem√¢ntico:**\n- Gemini 2.5 Flash\n- Coer√™ncia jur√≠dica\n- Precis√£o t√©cnica\n- Completude\n\n**Score Final:**\n40% estrutural + 60% sem√¢ntico\n\n**CNJ 615:**\n- BAIXO: ‚â•85, conf ‚â•0.85\n- MEDIO: ‚â•70, conf ‚â•0.65\n- ALTO: demais",
        "height": 360,
        "width": 240
      },
      "id": "sticky-qa",
      "name": "‚úÖ QA CHECK",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        3560,
        600
      ]
    },
    {
      "parameters": {
        "content": "## üìã AUDIT LOG\n\n**Persist√™ncia:** Google Sheets\n\n**Campos:**\n- ID √∫nico\n- Timestamp\n- Processo\n- Categoria/Agente\n- Scores (QA)\n- Risco CNJ 615\n- Hashes I/O\n- Tempo execu√ß√£o\n\n**Vari√°vel necess√°ria:**\n`AUDIT_SHEET_ID`",
        "height": 280,
        "width": 200
      },
      "id": "sticky-audit",
      "name": "üìã AUDIT",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        4720,
        600
      ]
    },
    {
      "parameters": {},
      "id": "error-trigger",
      "name": "Error Trigger",
      "type": "n8n-nodes-base.errorTrigger",
      "typeVersion": 1,
      "position": [
        540,
        700
      ]
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// ERROR HANDLER - Retry Logic\n// Lex Intelligentia Judici√°rio v2.1\n// ============================================================================\n\nconst errorData = $input.first().json;\n\n// Extrair informa√ß√µes do erro\nconst errorMessage = errorData.execution?.error?.message || 'Erro desconhecido';\nconst errorNode = errorData.execution?.lastNodeExecuted || 'Desconhecido';\nconst workflowId = errorData.workflow?.id || $execution.id;\n\n// Extrair tentativa atual do Context Buffer (se dispon√≠vel)\nlet tentativaAtual = 1;\ntry {\n  // Tentar buscar do workflow original\n  const contextBuffer = errorData.execution?.data?.resultData?.runData?.['Set Context Buffer']?.[0]?.data?.main?.[0]?.[0]?.json;\n  if (contextBuffer && contextBuffer.execucao) {\n    tentativaAtual = contextBuffer.execucao.tentativa || 1;\n  }\n} catch (e) {\n  tentativaAtual = 1;\n}\n\nconst MAX_TENTATIVAS = 3;\nconst shouldRetry = tentativaAtual < MAX_TENTATIVAS;\n\n// ============================================================================\n// LOG DO ERRO\n// ============================================================================\n\nconst errorLog = {\n  timestamp: new Date().toISOString(),\n  workflow_id: workflowId,\n  error: {\n    message: errorMessage,\n    node: errorNode,\n    tentativa: tentativaAtual,\n    max_tentativas: MAX_TENTATIVAS\n  },\n  action: shouldRetry ? 'RETRY' : 'FAIL',\n  next_tentativa: shouldRetry ? tentativaAtual + 1 : null\n};\n\nconsole.log('Error Handler:', JSON.stringify(errorLog));\n\n// ============================================================================\n// DECIS√ÉO: RETRY OU FAIL\n// ============================================================================\n\nif (shouldRetry) {\n  // Sinalizar para retry\n  return [{\n    json: {\n      should_retry: true,\n      tentativa: tentativaAtual + 1,\n      error_log: errorLog,\n      original_error: errorMessage,\n      failed_node: errorNode\n    }\n  }];\n} else {\n  // Falha final\n  return [{\n    json: {\n      should_retry: false,\n      tentativa: tentativaAtual,\n      error_log: errorLog,\n      original_error: errorMessage,\n      failed_node: errorNode,\n      final_failure: true\n    }\n  }];\n}"
      },
      "id": "handle-error",
      "name": "Handle Error",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        760,
        700
      ],
      "notes": "L√≥gica de retry at√© 3 tentativas"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "retry-check",
              "leftValue": "={{ $json.should_retry }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "if-retry",
      "name": "IF: Retry?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        980,
        700
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({\n  success: false,\n  timestamp: new Date().toISOString(),\n  error: {\n    message: $json.original_error,\n    node: $json.failed_node,\n    tentativas: $json.tentativa,\n    codigo: 'MAX_RETRIES_EXCEEDED'\n  },\n  compliance: {\n    risco: 'ALTO',\n    requer_revisao_humana: true,\n    motivo: 'Falha de processamento ap√≥s m√∫ltiplas tentativas'\n  },\n  rastreabilidade: {\n    workflow_id: $execution.id,\n    error_log: $json.error_log\n  },\n  meta: {\n    versao_api: '2.1',\n    sistema: 'Lex Intelligentia Judici√°rio'\n  }\n}) }}",
        "responseCode": 500,
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "X-Error-Code",
                "value": "MAX_RETRIES_EXCEEDED"
              },
              {
                "name": "X-Risk-Level",
                "value": "ALTO"
              },
              {
                "name": "X-Retry-Count",
                "value": "={{ $json.tentativa }}"
              }
            ]
          }
        }
      },
      "id": "respond-error",
      "name": "Respond: Error",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        1200,
        800
      ],
      "notes": "Resposta de erro ap√≥s esgotar retries"
    },
    {
      "parameters": {
        "content": "## ‚ö†Ô∏è ERROR HANDLING\n\n**Estrat√©gia:** Retry at√© 3x\n\n**Fluxo:**\n```\n[Erro] ‚Üí [Error Trigger]\n    ‚Üì\n[Handle Error]\n    ‚Üì\n[IF: Retry?]\n  ‚îú‚Üí SIM: [Log + Notify]\n  ‚îî‚Üí N√ÉO: [Respond: Error]\n```\n\n**Ap√≥s 3 falhas:**\n- Response 500\n- Risco: ALTO\n- Log completo do erro",
        "height": 300,
        "width": 240
      },
      "id": "sticky-error",
      "name": "‚ö†Ô∏è ERROR HANDLING",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        540,
        900
      ]
    },
    {
      "parameters": {
        "operation": "append",
        "documentId": {
          "__rl": true,
          "value": "={{ $env.AUDIT_SHEET_ID }}",
          "mode": "id"
        },
        "sheetName": {
          "__rl": true,
          "value": "Errors",
          "mode": "list"
        },
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Timestamp": "={{ $json.error_log.timestamp }}",
            "Workflow_ID": "={{ $json.error_log.workflow_id }}",
            "Error_Node": "={{ $json.failed_node }}",
            "Error_Message": "={{ $json.original_error }}",
            "Tentativa": "={{ $json.tentativa }}",
            "Action": "={{ $json.error_log.action }}",
            "Final_Failure": "={{ $json.final_failure || false }}"
          }
        },
        "options": {}
      },
      "id": "sheets-error-log",
      "name": "Google Sheets: Error Log",
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.5,
      "position": [
        1200,
        600
      ],
      "credentials": {
        "googleSheetsOAuth2Api": {
          "id": "GOOGLE_SHEETS_CREDENTIALS_ID",
          "name": "Google Sheets"
        }
      },
      "notes": "Log de erros no Google Sheets (aba Errors)"
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ JSON.stringify({\n  success: false,\n  timestamp: new Date().toISOString(),\n  error: {\n    message: $('Handle Error').item.json.original_error,\n    node: $('Handle Error').item.json.failed_node,\n    tentativa: $('Handle Error').item.json.tentativa,\n    codigo: 'TRANSIENT_ERROR'\n  },\n  retry: {\n    should_retry: true,\n    tentativas_restantes: 3 - $('Handle Error').item.json.tentativa,\n    retry_after_seconds: 5\n  },\n  compliance: {\n    risco: 'MEDIO',\n    requer_revisao_humana: true,\n    motivo: 'Erro transiente - retry recomendado'\n  },\n  rastreabilidade: {\n    workflow_id: $execution.id,\n    error_logged: true\n  },\n  meta: {\n    versao_api: '2.1',\n    sistema: 'Lex Intelligentia Judici√°rio'\n  }\n}) }}",
        "responseCode": 503,
        "options": {
          "responseHeaders": {
            "entries": [
              {
                "name": "X-Error-Code",
                "value": "TRANSIENT_ERROR"
              },
              {
                "name": "X-Risk-Level",
                "value": "MEDIO"
              },
              {
                "name": "Retry-After",
                "value": "5"
              },
              {
                "name": "X-Retry-Count",
                "value": "={{ $('Handle Error').item.json.tentativa }}"
              }
            ]
          }
        }
      },
      "id": "respond-retry",
      "name": "Respond: Retry",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1.1,
      "position": [
        1420,
        600
      ],
      "notes": "Resposta 503 indicando erro transiente - caller deve retry"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.ERROR_WEBHOOK_URL || 'https://your-alerting-system.com/webhook/n8n-failure' }}",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify({ \n  text: `üö® Alerta: Falha Persistente no Workflow Lex Intelligentia üö®\\n\\nWorkflow ID: ${$json.error_log.workflow_id}\\nN√≥ com Erro: ${$json.failed_node}\\nTentativas: ${$json.tentativa}\\n\\nMensagem:\\n${$json.original_error}`\n}) }}",
        "options": {}
      },
      "id": "notify-failure",
      "name": "Notify: Failure",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1200,
        820
      ],
      "notes": "Envia notifica√ß√£o para sistema de alerta (e.g., Slack, Teams)"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict"
          },
          "conditions": [
            {
              "id": "stage2_condition",
              "leftValue": "={{ $json.classificacao?.needs_stage2 }}",
              "rightValue": true,
              "operator": {
                "type": "boolean",
                "operation": "equals"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "id": "needs_stage2_check",
      "name": "IF: Needs Stage 2",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1090,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ {\n  \"contents\": [{\n    \"parts\": [{\n      \"text\": `Voc√™ √© um sub-classificador jur√≠dico.\n\n√ÅREA IDENTIFICADA: ${$json.classificacao?.area || 'GENERICO'}\n\nTAREFA: Refine a classifica√ß√£o para o SUBTIPO espec√≠fico.\n\n${$json.classificacao?.area === 'SAUDE' ? `SUBTIPOS V√ÅLIDOS:\n- COBERTURA: negativa de procedimento, cirurgia, medicamento, home care, UTI\n- CONTRATUAL: reajuste abusivo, rescis√£o unilateral, car√™ncia, portabilidade` : ''}${$json.classificacao?.area === 'IMOBILIARIO' ? `SUBTIPOS V√ÅLIDOS:\n- USUCAPIAO: aquisi√ß√£o de propriedade por posse prolongada (qualquer modalidade)\n- INCORPORACAO: atraso na entrega, defeitos construtivos, distrato` : ''}\n\nCASO (FIRAC):\nFATOS: ${$json.firac?.fatos || 'N√£o informado'}\nQUEST√ïES: ${$json.firac?.questoes || 'N√£o informado'}\nPEDIDOS: ${$json.processo?.pedidos || 'N√£o informado'}\n\nRESPONDA APENAS com JSON v√°lido:\n{\n  \"subtipo\": \"string (COBERTURA, CONTRATUAL, USUCAPIAO, ou INCORPORACAO)\",\n  \"confianca_subtipo\": number (0.0 a 1.0)\n}`\n    }]\n  }],\n  \"generationConfig\": {\n    \"temperature\": 0.1,\n    \"maxOutputTokens\": 500\n  }\n} }}",
        "options": {
          "timeout": 30000
        }
      },
      "id": "gemini_stage2_router",
      "name": "Gemini Stage 2 Router",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1300,
        200
      ],
      "credentials": {
        "httpHeaderAuth": {
          "id": "GEMINI_CREDENTIALS_ID",
          "name": "Gemini API Key"
        }
      },
      "notes": "Stage 2 subtype classification for SAUDE and IMOBILIARIO areas"
    },
    {
      "parameters": {
        "jsCode": "// ============================================================================\n// PROCESS STAGE 2 RESULT - Merge subtype into context\n// Lex Intelligentia Judici√°rio v2.2 - Stage 2 Router\n// ============================================================================\n\n// Get original context from IF node\nconst ctx = $('IF: Needs Stage 2').item.json;\nconst stage2Response = $input.first().json;\n\n// Parse Stage 2 response\nlet subtipo = null;\nlet confianca_subtipo = 0;\n\ntry {\n  const responseText = stage2Response?.candidates?.[0]?.content?.parts?.[0]?.text || '';\n  const cleanJson = responseText.replace(/```json\\n?/g, '').replace(/```\\n?/g, '').trim();\n  const parsed = JSON.parse(cleanJson);\n  subtipo = parsed.subtipo;\n  confianca_subtipo = parsed.confianca_subtipo || 0;\n} catch (e) {\n  console.log('Stage 2 parse error:', e.message);\n}\n\n// Create a copy of context to modify\nconst updatedCtx = JSON.parse(JSON.stringify(ctx));\n\n// Update context with subtype\nif (subtipo && updatedCtx.classificacao) {\n  updatedCtx.classificacao.subtipo = subtipo;\n  updatedCtx.classificacao.confianca_subtipo = confianca_subtipo;\n  updatedCtx.classificacao.needs_stage2 = false; // Mark as processed\n  \n  // Update agente name based on area + subtipo\n  const area = updatedCtx.classificacao.categoria;\n  if (area === 'saude' || area === 'SAUDE') {\n    updatedCtx.classificacao.agente = `agent_saude_${subtipo.toLowerCase()}`;\n  } else if (area === 'imobiliario' || area === 'IMOBILIARIO') {\n    updatedCtx.classificacao.agente = `agent_${subtipo.toLowerCase()}`;\n  }\n}\n\nreturn [{ json: updatedCtx }];"
      },
      "id": "process_stage2_result",
      "name": "Process Stage 2 Result",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1520,
        200
      ],
      "notes": "Merges Stage 2 subtype classification into context buffer"
    },
    {
      "parameters": {
        "mode": "chooseBranch",
        "output": "input0"
      },
      "id": "merge_stage2",
      "name": "Merge Stage 2",
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3,
      "position": [
        1740,
        300
      ],
      "notes": "Merges Stage 2 branch (processed) with direct pass-through branch"
    },
    {
      "parameters": {
        "jsCode": "const crypto = require('crypto');\nconst ctx = $input.first().json;\n\nconst inputParaHash = JSON.stringify({\n  fatos: ctx.firac.fatos,\n  questoes: ctx.firac.questoes,\n  pedidos: (ctx.entidades.valores || []).join(',')\n});\n\nconst hash = crypto.createHash('sha256').update(inputParaHash).digest('hex');\nconst cacheKey = `lex_minuta:${ctx.classificacao.categoria}:${hash}`;\n\nreturn [{ json: { ...ctx, cache_key: cacheKey } }];"
      },
      "id": "calculate-hash",
      "name": "Calcular Hash do Input",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1960,
        300
      ]
    },
    {
      "parameters": {
        "method": "GET",
        "url": "={{ $env.REDIS_API_URL }}/get/{{ $json.cache_key }}",
        "authentication": "predefinedCredentialType",
        "predefinedCredentialType": "headerAuth",
        "predefinedCredentialName": "Redis API Auth",
        "options": {
          "continueOnFail": true
        }
      },
      "id": "read-cache",
      "name": "Ler do Cache (GET)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        2180,
        300
      ]
    },
    {
      "parameters": {
        "conditions": {
          "conditions": [
            {
              "value1": "={{ $json.result }}",
              "operation": "isNotNull"
            }
          ]
        }
      },
      "id": "cache-hit",
      "name": "Cache Hit?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        2400,
        300
      ]
    },
    {
      "parameters": {
        "method": "POST",
        "url": "={{ $env.REDIS_API_URL }}/set/{{ $json.contexto.cache_key }}?ex=2592000",
        "authentication": "predefinedCredentialType",
        "predefinedCredentialType": "headerAuth",
        "predefinedCredentialName": "Redis API Auth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { \"minuta_gerada\": $json.minuta_gerada, \"score\": $json.qa_result.score_final, \"cached_at\": new Date().toISOString() } }}",
        "options": {
          "continueOnFail": true
        }
      },
      "id": "write-cache",
      "name": "Escrever no Cache (SET)",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        3100,
        500
      ]
    },
    {
      "parameters": {
        "jsCode": "const cacheData = JSON.parse($('Ler do Cache (GET)').item.json.result);\nconst ctx = $('Calcular Hash do Input').item.json;\n\nconst response = {\n  success: true,\n  timestamp: new Date().toISOString(),\n  minuta: {\n    conteudo: cacheData.minuta_gerada,\n    palavras: cacheData.minuta_gerada.split(/\\s+/).length,\n    formato: 'markdown'\n  },\n  qualidade: {\n    score: cacheData.score,\n    aprovado: true,\n    detalhes: { \"fonte\": \"cache\" }\n  },\n  compliance: {\n    risco: \"BAIXO\",\n    agente: ctx.classificacao.agente\n  },\n  rastreabilidade: {\n    \"fonte\": \"cache\",\n    \"cache_key\": ctx.cache_key\n  }\n};\n\nreturn [{ json: response }];"
      },
      "id": "format-cache-response",
      "name": "Formatar Resposta do Cache",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2620,
        200
      ]
    },
    {
      "parameters": {
        "conditions": {
          "conditions": [
            {
              "value1": "={{ $json.qa_result.score_final }}",
              "operation": "largerEqual",
              "value2": 95
            }
          ]
        }
      },
      "id": "if-score-95",
      "name": "Score > 95?",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        4300,
        600
      ]
    },
    {
      "parameters": {
        "content": "## üîÄ STAGE 2 ROUTER v2.2\n\n**Objetivo:** Sub-classifica√ß√£o condicional\n\n**√Åreas com Stage 2:**\n- SAUDE ‚Üí COBERTURA | CONTRATUAL\n- IMOBILIARIO ‚Üí USUCAPIAO | INCORPORACAO\n\n**Fluxo:**\n```\n[Set Context Buffer]\n       ‚Üì\n[IF: needs_stage2?]\n  ‚îú‚Üí TRUE: [Gemini Stage 2]\n  ‚îÇ            ‚Üì\n  ‚îÇ     [Process Result]\n  ‚îÇ            ‚Üì\n  ‚îî‚Üí FALSE ‚îÄ‚Üí [Merge]\n                 ‚Üì\n         [Hash/Cache]\n```\n\n**Modelo:** gemini-2.0-flash\n**Temp:** 0.1",
        "height": 420,
        "width": 280
      },
      "id": "sticky-stage2",
      "name": "üîÄ STAGE 2",
      "type": "n8n-nodes-base.stickyNote",
      "typeVersion": 1,
      "position": [
        1060,
        480
      ]
    }
  ],
  "connections": {
    "Webhook: Recebe FIRAC": {
      "main": [
        [
          {
            "node": "Gemini Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gemini Router": {
      "main": [
        [
          {
            "node": "Set Context Buffer",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Context Buffer": {
      "main": [
        [
          {
            "node": "IF: Needs Stage 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF: Needs Stage 2": {
      "main": [
        [
          {
            "node": "Gemini Stage 2 Router",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Merge Stage 2",
            "type": "main",
            "index": 1
          }
        ]
      ]
    },
    "Gemini Stage 2 Router": {
      "main": [
        [
          {
            "node": "Process Stage 2 Result",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Process Stage 2 Result": {
      "main": [
        [
          {
            "node": "Merge Stage 2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge Stage 2": {
      "main": [
        [
          {
            "node": "Calcular Hash do Input",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Calcular Hash do Input": {
      "main": [
        [
          {
            "node": "Ler do Cache (GET)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ler do Cache (GET)": {
      "main": [
        [
          {
            "node": "Cache Hit?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Cache Hit?": {
      "main": [
        [
          {
            "node": "Formatar Resposta do Cache",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Set System Prompt",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formatar Resposta do Cache": {
      "main": [
        [
          {
            "node": "Respond: Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set System Prompt": {
      "main": [
        [
          {
            "node": "Switch: Seleciona Agente",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch: Seleciona Agente": {
      "main": [
        [
          {
            "node": "AI Agent: Banc√°rio",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent: Consumidor",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent: Execu√ß√£o",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent: Loca√ß√£o",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent: Possess√≥rias",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent: Sa√∫de Cobertura",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent: Sa√∫de Contratual",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent: Tr√¢nsito",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent: Usucapi√£o",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent: Incorpora√ß√£o",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent: Gen√©rico",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent: Gen√©rico",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Claude: Banc√°rio": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent: Banc√°rio",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Claude: Consumidor": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent: Consumidor",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Claude: Possess√≥rias": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent: Possess√≥rias",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Claude: Loca√ß√£o": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent: Loca√ß√£o",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Claude: Execu√ß√£o": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent: Execu√ß√£o",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Claude: Gen√©rico": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent: Gen√©rico",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Claude: Sa√∫de Cobertura": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent: Sa√∫de Cobertura",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Claude: Sa√∫de Contratual": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent: Sa√∫de Contratual",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Claude: Tr√¢nsito": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent: Tr√¢nsito",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Claude: Usucapi√£o": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent: Usucapi√£o",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Claude: Incorpora√ß√£o": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent: Incorpora√ß√£o",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent: Banc√°rio": {
      "main": [
        [
          {
            "node": "Prepare for QA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent: Consumidor": {
      "main": [
        [
          {
            "node": "Prepare for QA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent: Possess√≥rias": {
      "main": [
        [
          {
            "node": "Prepare for QA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent: Loca√ß√£o": {
      "main": [
        [
          {
            "node": "Prepare for QA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent: Execu√ß√£o": {
      "main": [
        [
          {
            "node": "Prepare for QA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent: Gen√©rico": {
      "main": [
        [
          {
            "node": "Prepare for QA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent: Sa√∫de Cobertura": {
      "main": [
        [
          {
            "node": "Prepare for QA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent: Sa√∫de Contratual": {
      "main": [
        [
          {
            "node": "Prepare for QA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent: Tr√¢nsito": {
      "main": [
        [
          {
            "node": "Prepare for QA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent: Usucapi√£o": {
      "main": [
        [
          {
            "node": "Prepare for QA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent: Incorpora√ß√£o": {
      "main": [
        [
          {
            "node": "Prepare for QA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Prepare for QA": {
      "main": [
        [
          {
            "node": "QA Estrutural",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "QA Estrutural": {
      "main": [
        [
          {
            "node": "IF: Executar QA Sem√¢ntico?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF: Executar QA Sem√¢ntico?": {
      "main": [
        [
          {
            "node": "QA Sem√¢ntico - Gemini",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "QA Consolidado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "QA Sem√¢ntico - Gemini": {
      "main": [
        [
          {
            "node": "QA Consolidado",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "QA Consolidado": {
      "main": [
        [
          {
            "node": "Audit Log CNJ 615",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Audit Log CNJ 615": {
      "main": [
        [
          {
            "node": "Google Sheets: Audit Log",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Sheets: Audit Log": {
      "main": [
        [
          {
            "node": "Build Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Response": {
      "main": [
        [
          {
            "node": "Respond: Success",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Error Trigger": {
      "main": [
        [
          {
            "node": "Handle Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Handle Error": {
      "main": [
        [
          {
            "node": "IF: Retry?",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF: Retry?": {
      "main": [
        [
          {
            "node": "Google Sheets: Error Log",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Notify: Failure",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Google Sheets: Error Log": {
      "main": [
        [
          {
            "node": "Respond: Retry",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Notify: Failure": {
      "main": [
        [
          {
            "node": "Respond: Error",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "settings": {
    "executionOrder": "v1"
  },
  "staticData": null,
  "tags": [
    {
      "name": "Lex Intelligentia"
    },
    {
      "name": "v2.1"
    },
    {
      "name": "Judicial"
    },
    {
      "name": "Multi-Model"
    }
  ],
  "triggerCount": 1,
  "updatedAt": "2026-01-19T00:00:00.000Z",
  "versionId": "2.2.0"
}